<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoVibe Widget</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18.2.0","react-dom/client":"https://esm.sh/react-dom@18.2.0/client","firebase/app":"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js","firebase/auth":"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js","firebase/database":"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js","lucide-react":"https://esm.sh/lucide-react@0.294.0"}}
</script>
<style>
/* SEAT STYLES */
.gv-seat {
  width: 55px; height: 55px; 
  background: #1e293b; 
  border-radius: 8px; 
  border: 2px solid #334155;
  display: flex; flex-direction: column; 
  align-items: center; justify-content: center; 
  cursor: pointer;
  transition: all 0.2s; 
  position: relative;
  user-select: none;
  margin: 2px;
}
.gv-seat:hover { transform: translateY(-2px); border-color: #94a3b8; }
.gv-seat:active { transform: scale(0.95); }
.gv-seat strong { font-size: 13px; color: white; line-height: 1; }
.gv-seat span { font-size: 8px; opacity: 0.7; color: #cbd5e1; margin-top: 2px; }

/* TOOLTIP */
.seat-tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 10;
  margin-bottom: 5px;
}
.gv-seat:hover .seat-tooltip { opacity: 1; }

/* SEAT TYPES */
.seat-driver { background: #312e81; border-color: #4338ca; cursor: default; opacity: 0.8; }

/* VIP: Purple Scheme */
.seat-vip { border-color: #a855f7 !important; color: #a855f7 !important; }
.seat-vip strong { color: #d8b4fe !important; }

/* STANDARD: Green Scheme */
.seat-standard { border-color: #10b981 !important; color: #10b981 !important; }

/* STATES */
.seat-selected { background: #2563eb !important; border-color: #3b82f6 !important; color: white !important; box-shadow: 0 0 10px rgba(37,99,235,0.5); }
.seat-selected strong, .seat-selected span { color: white !important; }

/* SOLD: Red */
.seat-sold { background: #ef4444 !important; border-color: #ef4444 !important; opacity: 0.4; cursor: not-allowed; }
.seat-sold strong { color: white !important; opacity: 0.5; }

/* HOLD: Orange */
.seat-hold { background: #f97316 !important; border-color: #f97316 !important; opacity: 0.8; cursor: not-allowed; }
.seat-hold strong { color: white !important; opacity: 0.8; }

/* BLOCK (Admin Manual Block): Gray */
.seat-block { background: #475569 !important; border-color: #64748b !important; opacity: 0.9; }

.price-badge { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { 0% {transform: scale(0.8); opacity: 0} 100% {transform: scale(1); opacity: 1} }

/* ALARM ANIMATION */
@keyframes bell-shake {
  0% { transform: rotate(0); }
  15% { transform: rotate(5deg); }
  30% { transform: rotate(-5deg); }
  45% { transform: rotate(4deg); }
  60% { transform: rotate(-4deg); }
  75% { transform: rotate(2deg); }
  85% { transform: rotate(-2deg); }
  100% { transform: rotate(0); }
}
.animate-bell { animation: bell-shake 2s infinite; }
</style>
</head>
<body>

<!-- Safety Loader -->
<div id="root" class="min-h-[600px] bg-slate-900 flex items-center justify-center text-white p-4">
  <div id="loader-content" class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
    <p class="text-lg" id="loading-text">Initializing GoVibeMX...</p>
    <p id="error-display" class="text-red-400 text-sm mt-4 hidden"></p>
  </div>
</div>

<!-- Global Error Trap -->
<script>
  window.onerror = function(msg, url, line, col, error) {
    const el = document.getElementById('error-display');
    const spin = document.querySelector('.animate-spin');
    if(el) {
      el.innerHTML = `<strong>System Error:</strong><br/>${msg}`;
      el.classList.remove('hidden');
      if(spin) spin.style.display = 'none';
    }
    return false;
  };
</script>

<!-- MAIN APP SCRIPT -->
<script type="text/babel" data-type="module">
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getDatabase, ref, onValue, push, update, remove, set } from 'firebase/database';
import { 
  Calendar, Clock, Users, CheckCircle, XCircle, Trash2, RefreshCw, 
  LayoutDashboard, MapPin, MessageCircle, Phone, Mail, DollarSign, 
  Settings, Lock, AlertCircle, Plus, Edit2, Save, Armchair, Info, 
  Wifi, Coffee, CreditCard, Loader2, AlertTriangle, Hand, Timer, 
  Bell, BellOff, HelpCircle, Send, Home
} from 'lucide-react';

// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAqFnjf1i-8Qm95Xzp98FFO0ABUxb7hzn4",
  authDomain: "govibebooking.firebaseapp.com",
  databaseURL: "https://govibebooking-default-rtdb.firebaseio.com",
  projectId: "govibebooking",
  storageBucket: "govibebooking.firebasestorage.app",
  messagingSenderId: "1043728861046",
  appId: "1:1043728861046:web:2c1c2ac6aea814d6c99c57"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app, firebaseConfig.databaseURL);

// --- SEAT DEFINITIONS ---
const ALL_SEATS = ['seat1', 'seat2', 'seat3', 'seat4', 'seat5', 'seat6'];

// Helper: Calculate Next Saturday for Default
const getNextSaturday = () => {
  const d = new Date();
  d.setDate(d.getDate() + (6 - d.getDay() + 7) % 7);
  d.setHours(8, 0, 0, 0);
  return d.getTime();
};

// Helper: Convert timestamp to local datetime string for input value
const toLocalISOString = (timestamp) => {
  if (!timestamp) return "";
  const date = new Date(timestamp);
  const offset = date.getTimezoneOffset() * 60000;
  return new Date(date.getTime() - offset).toISOString().slice(0, 16);
};

// --- AUDIO ALARM SYSTEM ---
const playAlertSound = () => {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, ctx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1); 
        
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
    } catch (e) {
        console.error("Audio Playback Failed", e);
    }
};

function App() {
  const [user, setUser] = useState(null);
  const [reservations, setReservations] = useState([]);
  const [inquiries, setInquiries] = useState([]);
  const [isConnected, setIsConnected] = useState(false);
  const [loading, setLoading] = useState(true);
  const [loadingMsg, setLoadingMsg] = useState("Authenticating...");
  const [viewMode, setViewMode] = useState('widget'); 
  
  const [isAdmin, setIsAdmin] = useState(false);
  const [showAdminLogin, setShowAdminLogin] = useState(false);
  const [adminPassword, setAdminPassword] = useState('');
  const [authError, setAuthError] = useState(null);

  const [selectedSeats, setSelectedSeats] = useState([]);
  const [showBookingModal, setShowBookingModal] = useState(false);
  const [showInquiryModal, setShowInquiryModal] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [editingBookingId, setEditingBookingId] = useState(null);
  const [infoData, setInfoData] = useState(null);
  const [submitError, setSubmitError] = useState(null);
  const [confirmData, setConfirmData] = useState(null);
  
  // Private & Alarm State
  const [isPrivateMode, setIsPrivateMode] = useState(false);
  const [isMuted, setIsMuted] = useState(true);
  const [hasPending, setHasPending] = useState(false);

  const [config, setConfig] = useState({
    vipPrice: 1200,
    windowPrice: 1000,
    middlePrice: 900,
    privatePrice: 6000, 
    discounts: { 2: 5, 3: 10, 4: 12, 5: 15, 6: 20 },
    tripName: 'TEOTIHUACÃN â˜€ï¸',
    tripDate: 'Saturday 8:00 AM',
    tripTimestamp: getNextSaturday(),
    noticeText: 'Meeting Point: Angel de la Independencia (Please arrive 15 min early).\n(Premium Leather Seats)'
  });

  const [timeLeft, setTimeLeft] = useState("");

  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    email: '',
    location: '',
    contactMethod: 'WhatsApp',
    hasWhatsApp: true,
    notes: '',
    message: '' 
  });

  // --- INITIALIZATION ---
  useEffect(() => {
    // Safety Timeout: Force load after 4 seconds if DB hangs
    const safetyTimer = setTimeout(() => {
        if(loading) {
            console.warn("Forcing load due to timeout");
            setLoading(false);
        }
    }, 4000);

    // Auth
    setLoadingMsg("Signing in...");
    signInAnonymously(auth).then(() => {
        setLoadingMsg("Connecting to Database...");
    }).catch(e => {
      if (e.code === 'auth/operation-not-allowed') setAuthError("Enable Anonymous Auth in Firebase Console.");
      else setAuthError(e.message);
      setLoading(false);
    });

    onAuthStateChanged(auth, u => {
      if (u) { setUser(u); setAuthError(null); }
      else { setUser(null); }
    });

    const connectedRef = ref(db, ".info/connected");
    const unsubConnected = onValue(connectedRef, snap => setIsConnected(!!snap.val()));

    const configRef = ref(db, "config");
    const unsubConfig = onValue(configRef, snap => {
      if (snap.val()) setConfig(prev => ({...prev, ...snap.val()}));
    });

    const bookingsRef = ref(db, 'bookings');
    const unsubBookings = onValue(bookingsRef, snap => {
      const data = snap.val();
      const loaded = [];
      if (data) {
        Object.keys(data).forEach(key => loaded.push({ id: key, ...data[key] }));
      }
      loaded.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      setReservations(loaded);
      setLoading(false); // Success load
    }, (err) => {
        console.error("DB Error", err);
        setLoading(false); // Fail load
    });

    const inquiriesRef = ref(db, 'inquiries');
    const unsubInquiries = onValue(inquiriesRef, snap => {
        const data = snap.val();
        const loaded = [];
        if (data) Object.keys(data).forEach(key => loaded.push({id: key, ...data[key]}));
        loaded.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        setInquiries(loaded);
    });

    return () => { 
        clearTimeout(safetyTimer);
        unsubConnected(); unsubConfig(); unsubBookings(); unsubInquiries(); 
    };
  }, []);

  // --- ALARM LOGIC ---
  useEffect(() => {
      const pendingExists = reservations.some(r => r.status === 'pending');
      setHasPending(pendingExists);
      if (pendingExists && !isMuted && isAdmin) {
          const interval = setInterval(() => playAlertSound(), 5000);
          return () => clearInterval(interval);
      }
  }, [reservations, isMuted, isAdmin]);

  // --- COUNTDOWN LOGIC ---
  useEffect(() => {
    const timer = setInterval(() => {
        if (!config.tripTimestamp) return;
        const now = new Date().getTime();
        const distance = config.tripTimestamp - now;
        if (distance < 0) setTimeLeft("Departed");
        else {
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            setTimeLeft(`${days}d ${hours}h ${minutes}m`);
        }
    }, 1000);
    return () => clearInterval(timer);
  }, [config.tripTimestamp]);

  // --- LOGIC ---
  const occupiedSeats = useMemo(() => {
    const map = {};
    reservations.forEach(r => {
      if (r.status === 'cancelled') return;
      if (editingBookingId && r.id === editingBookingId) return;
      
      let status = r.status === 'confirmed' ? 'sold' : 'hold';
      if (r.isManualBlock) status = 'block'; 

      if (Array.isArray(r.seats)) r.seats.forEach(seatId => map[seatId] = { status, name: r.name, id: r.id });
    });
    return map;
  }, [reservations, editingBookingId]);

  const quote = useMemo(() => {
    if (isPrivateMode) {
        return {
            baseTotal: config.privatePrice,
            discountPercent: 0,
            total: parseInt(config.privatePrice),
            count: 6,
            isPrivate: true
        };
    }

    let baseTotal = 0;
    selectedSeats.forEach(seatId => {
      if (['seat2', 'seat3'].includes(seatId)) baseTotal += parseInt(config.vipPrice);
      else if (['seat5'].includes(seatId)) baseTotal += parseInt(config.middlePrice);
      else baseTotal += parseInt(config.windowPrice);
    });
    const count = selectedSeats.length;
    let discountPercent = config.discounts && config.discounts[count] ? config.discounts[count] : 0;
    if (count >= 6) discountPercent = config.discounts && config.discounts[6] ? config.discounts[6] : 20;
    const total = Math.round(baseTotal * (1 - discountPercent / 100));
    return { baseTotal, discountPercent, total, count, isPrivate: false };
  }, [selectedSeats, config, isPrivateMode]);

  const handleDateChange = (e) => {
     const dateVal = e.target.value; 
     if (!dateVal) return;
     const dateObj = new Date(dateVal);
     const timestamp = dateObj.getTime();
     const displayStr = dateObj.toLocaleString('en-US', { weekday: 'long', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
     setConfig(prev => ({...prev, tripTimestamp: timestamp, tripDate: displayStr}));
  };

  const handleSeatClick = (id) => {
    if (viewMode === 'dashboard' && isAdmin) {
        const current = occupiedSeats[id];
        if (current) {
            remove(ref(db, `bookings/${current.id}`));
        } else {
            const newRef = push(ref(db, 'bookings'));
            set(newRef, { name: "ADMIN BLOCK", seats: [id], status: 'hold', isManualBlock: true, createdAt: Date.now(), createdBy: user ? user.uid : 'admin' });
        }
        return; 
    }

    if (occupiedSeats[id] && occupiedSeats[id].status) return;
    
    setSelectedSeats(prev => {
        const newSel = prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id];
        if(newSel.length === 6 && !isPrivateMode) {
             if(confirm("You selected all 6 seats. Would you like to book this tour as a private experience?")) {
                 setIsPrivateMode(true);
             }
        }
        return newSel;
    });
  };

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setSubmitError(null);
    setIsSubmitting(true);

    try {
      let currentUser = user;
      if (!currentUser) {
        const cred = await signInAnonymously(auth);
        currentUser = cred.user;
        setUser(currentUser); 
      }

      const finalSeats = isPrivateMode ? ALL_SEATS : selectedSeats;

      const bookingPayload = {
        name: formData.name,
        phone: formData.phone,
        email: formData.email,
        location: formData.location,
        contactMethod: formData.contactMethod,
        hasWhatsApp: formData.hasWhatsApp,
        notes: formData.notes,
        seats: finalSeats,
        totalPrice: quote.total,
        originalPrice: quote.baseTotal,
        discount: quote.discountPercent,
        isPrivate: isPrivateMode, 
        tripDate: config.tripDate,
        tripName: config.tripName,
        updatedAt: Date.now()
      };

      if (editingBookingId) {
        await update(ref(db, `bookings/${editingBookingId}`), bookingPayload);
        alert("Booking Updated!");
        setEditingBookingId(null);
        if (isAdmin) setViewMode('dashboard');
      } else {
        const newRef = push(ref(db, 'bookings'));
        await set(newRef, {
          ...bookingPayload,
          status: isAdmin ? 'confirmed' : 'pending',
          createdAt: Date.now(),
          createdBy: currentUser.uid
        });
        setShowSuccessModal(true);
      }

      setShowBookingModal(false);
      setSelectedSeats([]);
      setIsPrivateMode(false);
      setFormData({ name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '' });

    } catch (err) {
      console.error("Submission Error:", err);
      setSubmitError(err.message);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleInquirySubmit = async (e) => {
      e.preventDefault();
      setIsSubmitting(true);
      try {
          const newRef = push(ref(db, 'inquiries'));
          await set(newRef, {
              name: formData.name,
              phone: formData.phone,
              email: formData.email,
              contactMethod: formData.contactMethod,
              message: formData.message,
              status: 'NEW',
              timestamp: Date.now(),
              source: config.tripName
          });
          alert("Inquiry Sent! We will contact you shortly.");
          setShowInquiryModal(false);
          setFormData(prev => ({...prev, message: ''}));
      } catch(err) {
          alert("Error sending inquiry: " + err.message);
      } finally {
          setIsSubmitting(false);
      }
  };

  // --- WHATSAPP FUNCTION (SAME FRAME) ---
  const openWhatsApp = (r) => {
    const message = `Hello ${r.name}, thank you for reserving with GoVibeMX! ðŸš\n\n` +
                    `We're confirming your request:\n` +
                    `â€¢ Trip: ${r.tripName || 'GoVibe Tour'}\n` +
                    `â€¢ Date: ${r.tripDate || 'Upcoming'}\n` +
                    `â€¢ Pick-up: ${r.location || "Not specified"}\n` +
                    `â€¢ Seats: ${r.isPrivate ? 'PRIVATE VAN (All Seats)' : r.seats?.join(', ')}\n` +
                    `â€¢ Total: $${r.totalPrice}\n\n` +
                    `We will be with you shortly to confirm details!`;
    
    const url = `https://api.whatsapp.com/send?phone=${r.phone.replace(/\D/g,'')}&text=${encodeURIComponent(message)}`;
    
    window.top.location.href = url;
  };

  const handleStartEdit = (r) => {
    setEditingBookingId(r.id);
    setSelectedSeats(r.seats || []);
    setIsPrivateMode(r.isPrivate || false);
    setFormData({
      name: r.name||'', phone: r.phone||'', email: r.email||'', 
      location: r.location||'', contactMethod: r.contactMethod||'WhatsApp', 
      hasWhatsApp: r.hasWhatsApp, notes: r.notes||''
    });
    setViewMode('widget');
  };

  const handleStartNewBooking = () => {
      setEditingBookingId(null);
      setSelectedSeats([]);
      setIsPrivateMode(false);
      setFormData({ name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '' });
      setViewMode('widget'); 
  };

  const handleUpdateStatus = async (id, s) => {
    try { await update(ref(db, `bookings/${id}`), { status: s }); } catch (e) { alert(e.message); }
  };
  
  const updateInquiryStatus = async (id, s) => {
      try { await update(ref(db, `inquiries/${id}`), { status: s }); } catch(e) { alert(e.message); }
  }

  const requestDelete = (e, id) => {
    e.stopPropagation();
    setConfirmData({ type: 'delete', id: id, title: 'Permanently Delete this booking?' });
  };

  const requestWipe = (e) => {
    e.stopPropagation();
    setConfirmData({ type: 'wipe', title: 'WARNING: Wipe ALL bookings from database?' });
  };

  const executeConfirmAction = async () => {
    if(!confirmData) return;
    try {
      if(confirmData.type === 'delete') await remove(ref(db, `bookings/${confirmData.id}`));
      else if(confirmData.type === 'wipe') await remove(ref(db, 'bookings'));
      setConfirmData(null); 
    } catch(err) {
      alert("Error: " + err.message);
    }
  };

  const handleLogin = (e) => {
    e.preventDefault();
    if (adminPassword === 'govibe123') {
      setIsAdmin(true); setShowAdminLogin(false); setViewMode('dashboard'); setAdminPassword('');
    } else { alert('Incorrect Password'); }
  };

  const toggleMute = () => { setIsMuted(!isMuted); };

  const Seat = ({ id, label, subLabel, type, isInteractive = true }) => {
    const data = occupiedSeats[id]; 
    const status = data ? data.status : null;
    const occupantName = data ? data.name : null;

    let className = `gv-seat seat-${type}`;
    
    if (status === 'sold') className = `gv-seat seat-sold`;
    else if (status === 'hold') className = `gv-seat seat-hold`;
    else if (status === 'block') className = `gv-seat seat-block`; 
    
    if (selectedSeats.includes(id)) className = `gv-seat seat-selected`;

    if (!isInteractive) className += ' cursor-default';
    if (isAdmin && viewMode === 'dashboard') className += ' cursor-pointer hover:ring-2 hover:ring-white';

    let seatPrice = 0;
    if (['seat2', 'seat3'].includes(id)) seatPrice = config.vipPrice;
    else if (id === 'seat5') seatPrice = config.middlePrice;
    else seatPrice = config.windowPrice;

    return (
      <div onClick={isInteractive || (isAdmin && viewMode === 'dashboard') ? () => handleSeatClick(id) : undefined} className={className}>
        <strong>{label}</strong>
        <span>{subLabel}</span>
        <div className="seat-tooltip">
           {isAdmin && occupantName ? occupantName : (isPrivateMode ? 'Included' : `$${seatPrice}`)}
        </div>
      </div>
    );
  };

  // MAP LAYOUT
  const SeatMapLayout = ({ isInteractive = true }) => (
    <>
      <div className="text-center mb-2 text-[10px] text-slate-500 uppercase tracking-widest">Front Row</div>
      <div className="flex justify-center gap-4 mb-4">
        <div className="gv-seat seat-driver"><span className="text-[10px] text-indigo-200 font-bold">DRIVER</span></div>
        <Seat id="seat1" label="#1" subLabel="Co-Pilot" type="standard" isInteractive={isInteractive}/>
      </div>
      <div className="text-center mb-2 text-[10px] text-amber-500 uppercase tracking-widest">VIP Captains</div>
      <div className="flex justify-center gap-4 mb-4">
        <Seat id="seat2" label="#2" subLabel="Captain" type="vip" isInteractive={isInteractive}/>
        <Seat id="seat3" label="#3" subLabel="Captain" type="vip" isInteractive={isInteractive}/>
      </div>
      <div className="text-center mb-2 text-[10px] text-slate-500 uppercase tracking-widest">Bench Row</div>
      <div className="flex justify-center gap-4 mb-6">
        <Seat id="seat4" label="#4" subLabel="Win" type="standard" isInteractive={isInteractive}/>
        <Seat id="seat5" label="#5" subLabel="Mid" type="standard" isInteractive={isInteractive}/>
        <Seat id="seat6" label="#6" subLabel="Win" type="standard" isInteractive={isInteractive}/>
      </div>
    </>
  );

  if (loading) {
     return (
        <div className="min-h-[600px] bg-slate-900 flex items-center justify-center text-white p-4">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
            <p className="text-lg">{loadingMsg}</p>
            {authError && <p className="text-red-400 text-sm mt-4 font-bold">{authError}</p>}
          </div>
        </div>
     );
  }

  return (
    <div className="min-h-[600px] bg-slate-900 font-sans text-slate-100 relative pb-20">
      
      {/* STATUS */}
      <div className="fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700 shadow-lg text-xs">
        <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`}></div>
        <span>{authError ? 'Setup Error' : (isConnected ? 'System Online' : 'Reconnecting...')}</span>
      </div>

      {/* HEADER */}
      <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-20">
        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <img src="https://img1.wsimg.com/isteam/ip/a2f36b16-54d7-45cc-96f6-48f6a722fb83/GoVibeAlta.png/:/rs=w:1344,h:600,cg:true,m/cr=w:1344,h:600/qt=q:95" className="h-10 object-contain"/>
          </div>
          <div className="flex bg-slate-700 p-1 rounded-lg items-center">
             {isAdmin && viewMode === 'dashboard' && (
                <button onClick={toggleMute} className={`mr-2 p-2 rounded-full transition-colors ${isMuted ? 'text-red-400 bg-red-900/20' : 'text-green-400 bg-green-900/20'} ${hasPending && !isMuted ? 'animate-bell' : ''}`} title={isMuted ? "Unmute Alarm" : "Mute Alarm"}>
                   {isMuted ? <BellOff className="w-4 h-4" /> : <Bell className="w-4 h-4" />}
                </button>
             )}
            <button onClick={() => { setViewMode('widget'); setEditingBookingId(null); setSelectedSeats([]); setIsPrivateMode(false); }} className={`px-4 py-1.5 rounded text-sm ${viewMode === 'widget' ? 'bg-slate-600 text-white' : 'text-slate-400'}`}>Widget</button>
            <button onClick={() => isAdmin ? setViewMode('dashboard') : setShowAdminLogin(true)} className={`flex items-center gap-2 px-4 py-1.5 rounded text-sm ${viewMode !== 'widget' ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}>{isAdmin ? <LayoutDashboard className="w-4 h-4"/> : <Lock className="w-4 h-4"/>} Admin</button>
          </div>
        </div>
      </header>

      {/* CONFIRM ACTION MODAL */}
      {confirmData && (
        <div className="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4">
          <div className="bg-slate-800 p-6 rounded-xl border border-red-500/50 w-full max-w-sm shadow-2xl text-center">
            <div className="flex justify-center mb-4 text-red-500"><AlertTriangle className="w-10 h-10" /></div>
            <h3 className="text-lg font-bold text-white mb-2">Are you sure?</h3>
            <p className="text-slate-400 text-sm mb-6">{confirmData.title}</p>
            <div className="flex gap-3">
              <button onClick={() => setConfirmData(null)} className="flex-1 bg-slate-700 p-2 rounded-lg hover:bg-slate-600 transition-colors">Cancel</button>
              <button onClick={executeConfirmAction} className="flex-1 bg-red-600 text-white p-2 rounded-lg hover:bg-red-500 font-bold transition-colors">Yes, Do it</button>
            </div>
          </div>
        </div>
      )}

      {/* LOGIN MODAL */}
      {showAdminLogin && (
        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
          <div className="bg-slate-800 p-8 rounded-xl border border-slate-700 w-full max-w-sm shadow-2xl">
            <h3 className="text-xl font-bold mb-4">Admin Login</h3>
            <form onSubmit={handleLogin}>
              <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} placeholder="Password" className="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
              <div className="flex gap-3">
                <button type="button" onClick={() => setShowAdminLogin(false)} className="flex-1 bg-slate-700 p-2 rounded">Cancel</button>
                <button type="submit" className="flex-1 bg-indigo-600 p-2 rounded">Login</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* WIDGET VIEW */}
      {viewMode === 'widget' && (
        <div className="p-4 flex justify-center w-full">
          <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            
            {/* INFO PANEL */}
            <div className="bg-slate-800/50 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm order-2 md:order-1">
              <div className="space-y-4">
                <div>
                  <h2 className="text-3xl font-bold text-white">{config.tripName}</h2>
                  <div className="flex items-center gap-2 text-indigo-400 mt-2">
                     <Calendar className="w-4 h-4"/>
                     <span>{config.tripDate}</span>
                  </div>
                  {/* ADDED: COUNTDOWN TIMER */}
                  <div className="flex items-center gap-2 text-amber-400 text-sm mt-1 font-mono font-bold">
                     <Timer className="w-4 h-4" />
                     <span>{timeLeft || "Loading..."}</span>
                  </div>
                </div>
                {editingBookingId && <div className="bg-amber-900/30 border border-amber-600/50 p-3 rounded text-amber-200 text-sm font-bold flex items-center gap-2"><Edit2 className="w-4 h-4"/> EDITING MODE</div>}
                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50">
                  <p className="text-sm text-slate-400 mb-2 font-medium">Notice Board</p>
                  <p className="text-slate-200 text-sm whitespace-pre-wrap">{config.noticeText}</p>
                </div>
                <div className="flex gap-6 text-xs text-slate-400 border-t border-slate-700 pt-4">
                  <div className="flex items-center gap-1.5"><Wifi className="w-4 h-4 text-indigo-400"/> WiFi</div>
                  <div className="flex items-center gap-1.5"><Coffee className="w-4 h-4 text-amber-400"/> Snacks</div>
                  <div className="flex items-center gap-1.5"><CreditCard className="w-4 h-4 text-green-400"/> Cards</div>
                </div>
                
                {/* INQUIRY BUTTON */}
                <button onClick={() => setShowInquiryModal(true)} className="w-full border border-slate-600 text-slate-300 py-2 rounded-lg text-sm hover:bg-slate-800 flex items-center justify-center gap-2 mt-2">
                    <HelpCircle className="w-4 h-4"/> Have a question? Inquire Here
                </button>

                <div className="mt-6 p-6 bg-slate-900 rounded-xl border border-slate-700 text-center relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500"></div>
                  {quote.count > 0 || isPrivateMode ? (
                    <div className="price-badge">
                      <div className="text-slate-400 text-xs uppercase tracking-wider">{isPrivateMode ? "PRIVATE TOUR PRICE" : "Total Amount"}</div>
                      <div className="flex items-center justify-center gap-2">
                         {!isPrivateMode && quote.discountPercent > 0 && <span className="text-slate-500 line-through text-lg">${quote.baseTotal}</span>}
                         <div className="text-3xl font-bold text-cyan-400 my-1">${quote.total} MXN</div>
                      </div>
                      {isPrivateMode ? <div className="text-xs text-indigo-400 font-bold">FULL VAN RESERVED</div> : (quote.discountPercent > 0 && <div className="inline-block text-[10px] bg-green-900/50 text-green-400 px-2 py-0.5 rounded border border-green-800">SAVED {quote.discountPercent}%</div>)}
                    </div>
                  ) : <div className="text-slate-500 text-sm">Select seats on map</div>}
                </div>
              </div>
            </div>

            {/* SEAT MAP */}
            <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl relative order-1 md:order-2">
              <SeatMapLayout isInteractive={!isPrivateMode} />
              
              {/* LEGEND */}
              <div className="flex justify-center gap-3 text-[10px] text-slate-400 border-t border-slate-700 pt-4 mb-4 flex-wrap">
                 <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-indigo-500"></div>Open</div>
                 <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-transparent border border-a855f7"></div>VIP</div>
                 <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-blue-600"></div>You</div>
                 <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-f97316"></div>Hold</div>
                 <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-red-500"></div>Sold</div>
                 {isAdmin && <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-slate-500"></div>Block</div>}
              </div>

              <button disabled={!quote.count && !isPrivateMode} onClick={() => setShowBookingModal(true)} className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all ${quote.count || isPrivateMode ? (editingBookingId ? 'bg-amber-600 hover:bg-amber-500 text-white' : 'bg-indigo-600 hover:bg-indigo-500 text-white') : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>
                {quote.count || isPrivateMode ? (editingBookingId ? 'Modify Booking' : 'Reserve Seats') : 'Select Seats'}
              </button>
              {editingBookingId && <button onClick={() => { setEditingBookingId(null); setSelectedSeats([]); if(isAdmin) setViewMode('dashboard'); }} className="w-full mt-3 py-2 text-xs text-slate-400 hover:text-white">Cancel Editing</button>}
            </div>
          </div>
        </div>
      )}

      {/* INQUIRY MODAL */}
      {showInquiryModal && (
         <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
            <div className="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl">
               <div className="p-6 border-b border-slate-700 flex justify-between items-center">
                 <h3 className="text-xl font-bold text-white">Inquire About Tour</h3>
                 <button onClick={() => setShowInquiryModal(false)}><XCircle className="w-6 h-6 text-slate-400 hover:text-white"/></button>
               </div>
               <form onSubmit={handleInquirySubmit} className="p-6 space-y-4">
                  <input required name="name" value={formData.name} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Full Name"/>
                  <div className="grid grid-cols-2 gap-4">
                    <select name="contactMethod" value={formData.contactMethod} onChange={handleInputChange} className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none">
                       <option>WhatsApp</option><option>Email</option>
                    </select>
                    <input required type="tel" name="phone" value={formData.phone} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Phone"/>
                  </div>
                  <input type="email" name="email" value={formData.email} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Email"/>
                  <textarea required name="message" value={formData.message} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="How can we help? (Custom dates, private tours, etc.)" rows="3"/>
                  <button type="submit" disabled={isSubmitting} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2">
                     {isSubmitting ? "Sending..." : <><Send className="w-4 h-4"/> Send Inquiry</>}
                  </button>
               </form>
            </div>
         </div>
      )}

      {/* BOOKING MODAL */}
      {showBookingModal && (
        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
          <div className="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-6 border-b border-slate-700 flex justify-between items-center">
              <h3 className="text-xl font-bold text-white">{editingBookingId ? 'Edit Reservation' : 'Complete Reservation'}</h3>
              <button onClick={() => setShowBookingModal(false)}><XCircle className="w-6 h-6 text-slate-400 hover:text-white"/></button>
            </div>
            <form onSubmit={handleSave} className="p-6 space-y-4">
              {submitError && <div className="bg-red-900/30 border border-red-500/50 p-3 rounded text-red-200 text-xs flex items-start gap-2"><AlertCircle className="w-4 h-4 shrink-0 mt-0.5"/><div><strong>Error:</strong> {submitError}</div></div>}
              <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700 mb-4 text-sm flex justify-between items-center">
                <span className="text-slate-400">Seats: <span className="text-white font-mono">{isPrivateMode ? 'ALL (Private)' : selectedSeats.join(', ')}</span></span>
                <span className="text-cyan-400 font-bold text-lg">${quote.total}</span>
              </div>
              
              {/* PRIVATE TOUR OPTION */}
              {!editingBookingId && (
                 <div className="flex items-start gap-3 bg-indigo-900/20 border border-indigo-500/30 p-3 rounded-lg">
                    <input type="checkbox" id="privateCheck" checked={isPrivateMode} onChange={e => setIsPrivateMode(e.target.checked)} className="mt-1"/>
                    <div>
                       <label htmlFor="privateCheck" className="text-sm font-bold text-white cursor-pointer">Make this a private tour</label>
                       <p className="text-xs text-slate-400 mt-1">Book the entire van for ${config.privatePrice}. Perfect for families or groups.</p>
                    </div>
                 </div>
              )}

              <input required name="name" value={formData.name} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Full Name"/>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Preferred Contact Method</label>
                  <select name="contactMethod" value={formData.contactMethod} onChange={handleInputChange} className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none">
                    <option>WhatsApp</option><option>Phone Call</option><option>Email</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Phone Number</label>
                  <input required type="tel" name="phone" value={formData.phone} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Phone"/>
                </div>
              </div>
              <input name="location" value={formData.location} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Pickup / Hotel"/>
              <input type="email" name="email" value={formData.email} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Email (Optional)"/>
              {isAdmin && <textarea name="notes" value={formData.notes} onChange={handleInputChange} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none" placeholder="Internal Notes" rows="2"/>}
              <button type="submit" disabled={isSubmitting} className={`w-full p-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors ${editingBookingId ? 'bg-amber-600 hover:bg-amber-500 text-white' : 'bg-indigo-600 hover:bg-indigo-500 text-white'}`}>
                {isSubmitting ? <><Loader2 className="w-4 h-4 animate-spin"/> Processing...</> : (editingBookingId ? 'Update Booking' : 'Confirm')}
              </button>
            </form>
          </div>
        </div>
      )}

      {/* SUCCESS MODAL */}
      {showSuccessModal && (
        <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4">
          <div className="text-center max-w-sm animate-in zoom-in duration-300">
            <div className="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500/50">
              <CheckCircle className="w-10 h-10 text-green-500" />
            </div>
            <h2 className="text-2xl font-bold text-white mb-2">Reservation Received!</h2>
            <p className="text-slate-400 mb-8">Seats are now ON HOLD.<br/>We will contact you shortly to confirm.</p>
            <button onClick={() => setShowSuccessModal(false)} className="bg-slate-800 hover:bg-slate-700 text-white px-8 py-3 rounded-full font-medium transition-colors border border-slate-700">Close</button>
          </div>
        </div>
      )}

      {/* INFO MODAL */}
      {infoData && (
        <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
          <div className="bg-slate-800 w-full max-w-sm rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
              <h3 className="text-lg font-bold text-white">Booking Details</h3>
              <button onClick={() => setInfoData(null)}><XCircle className="w-6 h-6 text-slate-400 hover:text-white"/></button>
            </div>
            <div className="p-6 space-y-4 text-sm">
              <div className="space-y-2">
                <div className="flex justify-between border-b border-slate-700 pb-2"><span className="text-slate-400">Name</span><span className="text-white font-medium text-right">{infoData.name}</span></div>
                <div className="flex justify-between border-b border-slate-700 pb-2"><span className="text-slate-400">Contact</span><span className="text-white text-right">{infoData.phone}<br/><span className="text-xs text-slate-500">via {infoData.contactMethod}</span></span></div>
                {infoData.email && <div className="flex justify-between border-b border-slate-700 pb-2"><span className="text-slate-400">Email</span><span className="text-white text-right">{infoData.email}</span></div>}
                <div className="flex justify-between border-b border-slate-700 pb-2"><span className="text-slate-400">Location</span><span className="text-white text-right">{infoData.location || "N/A"}</span></div>
              </div>
              <div className="bg-slate-900 rounded-lg p-3 space-y-1">
                <div className="flex justify-between text-xs text-slate-400"><span>Type</span> <span className={infoData.isPrivate ? "text-indigo-400 font-bold" : "text-white"}>{infoData.isPrivate ? "PRIVATE VAN" : "Shared Seats"}</span></div>
                <div className="flex justify-between text-xs text-slate-400"><span>Seats</span> <span>{infoData.seats?.join(', ')}</span></div>
                <div className="flex justify-between font-bold text-white border-t border-slate-700 pt-1 mt-1"><span>Total</span> <span>${infoData.totalPrice}</span></div>
              </div>
              {infoData.notes && <div className="bg-amber-900/20 border border-amber-900/50 p-3 rounded-lg"><p className="text-xs text-amber-500 font-bold mb-1">NOTES</p><p className="text-amber-200 italic">{infoData.notes}</p></div>}
              <div className="text-[10px] text-slate-600 text-center pt-2">ID: {infoData.id}</div>
            </div>
          </div>
        </div>
      )}

      {/* ADMIN DASHBOARD */}
      {(viewMode === 'dashboard' || viewMode === 'settings' || viewMode === 'inquiries') && isAdmin && (
        <main className="max-w-6xl mx-auto px-4 py-8">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div><h2 className="text-2xl font-bold text-white">Admin Dashboard</h2><p className="text-slate-400 text-sm">Manage bookings & settings</p></div>
            <div className="flex flex-wrap gap-2">
              <button onClick={() => setViewMode(viewMode === 'inquiries' ? 'dashboard' : 'inquiries')} className={`flex items-center gap-2 px-3 py-2 text-xs font-bold border rounded-lg ${viewMode === 'inquiries' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-300 border-slate-700'}`}><HelpCircle className="w-4 h-4"/> {viewMode === 'inquiries' ? 'Back' : 'Inquiries'}</button>
              <button onClick={() => setViewMode(viewMode === 'settings' ? 'dashboard' : 'settings')} className={`flex items-center gap-2 px-3 py-2 text-xs font-bold border rounded-lg ${viewMode === 'settings' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-300 border-slate-700'}`}><Settings className="w-4 h-4"/> {viewMode === 'settings' ? 'Back' : 'Settings'}</button>
              <button onClick={() => setViewMode('dashboard')} className="flex items-center gap-2 px-3 py-2 text-xs font-bold bg-slate-800 border border-slate-700 rounded-lg text-white hover:bg-slate-700"><Home className="w-4 h-4"/> Dashboard</button>
              <button onClick={requestWipe} className="flex items-center gap-2 px-3 py-2 text-xs font-bold text-red-400 bg-red-900/20 border border-red-900/50 rounded-lg hover:bg-red-900/40"><Trash2 className="w-4 h-4"/> WIPE ALL</button>
              <button onClick={() => { setIsAdmin(false); setViewMode('widget'); }} className="px-3 py-2 text-xs font-bold text-slate-300 bg-slate-800 border border-slate-700 rounded-lg">LOGOUT</button>
            </div>
          </div>

          {viewMode === 'settings' ? (
            <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 max-w-lg mx-auto">
              <h3 className="font-bold text-white mb-4 pb-2 border-b border-slate-700">Trip Details</h3>
              <div className="mb-4 space-y-3">
                <div><label className="text-xs text-slate-400 block mb-1">Trip Name</label><input className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm" value={config.tripName} onChange={e => setConfig({...config, tripName: e.target.value})} /></div>
                <div><label className="text-xs text-slate-400 block mb-1">Trip Date & Time</label><input type="datetime-local" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm" value={toLocalISOString(config.tripTimestamp)} onChange={handleDateChange} /></div>
                <div><label className="text-xs text-slate-400 block mb-1">Notice Board</label><textarea className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm" rows="2" value={config.noticeText} onChange={e => setConfig({...config, noticeText: e.target.value})} /></div>
              </div>

              <h3 className="font-bold text-white mb-4 pb-2 border-b border-slate-700">Prices & Discounts</h3>
              <div className="grid grid-cols-2 gap-3 mb-2">
                  <div><label className="text-xs text-slate-400 block mb-1">Private Tour Price</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm font-bold text-indigo-400" value={config.privatePrice} onChange={e => setConfig({...config, privatePrice: e.target.value})} /></div>
              </div>
              <div className="grid grid-cols-3 gap-3 mb-6">
                {['vipPrice', 'windowPrice', 'middlePrice'].map(k => (
                  <div key={k}><label className="text-xs text-slate-400 block mb-1 capitalize">{k.replace('Price', '')}</label><input type="number" value={config[k]} onChange={e => setConfig({ ...config, [k]: e.target.value })} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm" /></div>
                ))}
              </div>
              <div className="grid grid-cols-5 gap-2 mb-6">
                {[2, 3, 4, 5, 6].map(n => (
                  <div key={n}><label className="text-xs text-slate-400 block mb-1">{n} Seats</label><input type="number" value={config.discounts?.[n] || 0} onChange={e => setConfig({ ...config, discounts: { ...config.discounts, [n]: e.target.value } })} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-center text-sm" /></div>
                ))}
              </div>
              <button onClick={() => update(ref(db, 'config'), config).then(() => alert('Saved'))} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2"><Save className="w-4 h-4"/> Save Configuration</button>
            </div>
          ) : viewMode === 'inquiries' ? (
              <div className="space-y-4">
                  {inquiries.length === 0 ? <div className="text-slate-500 text-center py-10">No inquiries yet.</div> : inquiries.map(i => (
                      <div key={i.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                          <div className="flex justify-between items-start">
                              <div>
                                  <div className="flex items-center gap-2">
                                    <h4 className="font-bold text-white">{i.name}</h4>
                                    <span className={`text-[10px] px-2 py-0.5 rounded uppercase font-bold ${i.status === 'NEW' ? 'bg-blue-900 text-blue-200' : 'bg-slate-700 text-slate-400'}`}>{i.status}</span>
                                  </div>
                                  <p className="text-slate-400 text-sm mt-1">{i.message}</p>
                                  <div className="text-xs text-slate-500 mt-2 flex gap-3">
                                      <span>{new Date(i.timestamp).toLocaleString()}</span>
                                      <span>{i.phone}</span>
                                      <span>{i.email}</span>
                                  </div>
                              </div>
                              <div className="flex gap-2">
                                  <button onClick={() => {
                                     const url = `https://api.whatsapp.com/send?phone=${i.phone.replace(/\D/g,'')}&text=${encodeURIComponent(`Hi ${i.name}, regarding your inquiry about ${i.source}:`)}`;
                                     window.top.location.href = url;
                                  }} className="p-2 bg-green-600 rounded text-white hover:bg-green-500"><MessageCircle className="w-4 h-4"/></button>
                                  {i.status === 'NEW' && <button onClick={() => updateInquiryStatus(i.id, 'RESPONDED')} className="p-2 bg-slate-700 rounded text-slate-300 hover:bg-slate-600 text-xs">Mark Read</button>}
                              </div>
                          </div>
                      </div>
                  ))}
              </div>
          ) : (
            <>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-start"><div><p className="text-slate-400 text-xs uppercase font-bold">Revenue</p><h3 className="text-2xl font-bold text-white mt-1">${reservations.filter(r => r.status === 'confirmed').reduce((a, c) => a + (c.totalPrice || 0), 0)}</h3></div><div className="bg-indigo-500/20 p-2 rounded"><DollarSign className="w-5 h-5 text-indigo-400"/></div></div>
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-start"><div><p className="text-slate-400 text-xs uppercase font-bold">Holds</p><h3 className="text-2xl font-bold text-amber-500 mt-1">{reservations.filter(r => r.status === 'pending').length}</h3></div><div className="bg-amber-500/20 p-2 rounded"><Clock className="w-5 h-5 text-amber-500"/></div></div>
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-start"><div><p className="text-slate-400 text-xs uppercase font-bold">Sold Seats</p><h3 className="text-2xl font-bold text-green-500 mt-1">{Object.values(occupiedSeats).filter(s => s.status === 'sold').length} <span className="text-sm text-slate-500 font-normal">/ 6</span></h3></div><div className="bg-green-500/20 p-2 rounded"><Users className="w-5 h-5 text-green-500"/></div></div>
              </div>

              {/* LIVE SEAT MAP IN DASHBOARD */}
              <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8 max-w-2xl mx-auto shadow-lg">
                <h3 className="text-center text-slate-400 text-xs font-bold uppercase mb-4 tracking-widest flex justify-between items-center">
                   <span>Live Availability</span>
                   <span className="text-[10px] text-slate-500 font-normal normal-case">Click seat to Block/Unblock</span>
                </h3>
                <SeatMapLayout isInteractive={true} />
              </div>

              <div className="flex justify-between items-center mb-4">
                <h3 className="text-white font-bold">Bookings List</h3>
                <button onClick={handleStartNewBooking} className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2"><Plus className="w-4 h-4"/> New Booking</button>
              </div>

              <div className="space-y-3">
                {reservations.map(r => (
                  <div key={r.id} className={`bg-slate-800 rounded-xl p-4 border shadow-sm flex flex-col md:flex-row justify-between gap-4 transition-all ${r.status === 'confirmed' ? 'border-l-4 border-l-green-500 border-y-slate-700 border-r-slate-700' : r.status === 'cancelled' ? 'border-l-4 border-l-red-500 border-y-slate-700 border-r-slate-700 opacity-60' : 'border-l-4 border-l-amber-500 border-y-slate-700 border-r-slate-700'}`}>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h3 className="font-bold text-white text-lg">{r.name}</h3>
                        {r.isPrivate ? <span className="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-indigo-600 text-white">PRIVATE VAN</span> : (r.isManualBlock ? <span className="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-600 text-slate-200">BLOCKED</span> : 
                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${r.status === 'confirmed' ? 'bg-green-900/30 text-green-400' : r.status === 'cancelled' ? 'bg-red-900/30 text-red-400' : 'bg-amber-900/30 text-amber-400'}`}>{r.status === 'pending' ? 'HOLD' : r.status}</span>)}
                      </div>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-slate-400">
                        <span className="flex items-center gap-1"><Users className="w-3 h-3"/> {r.isPrivate ? 'ALL' : r.seats?.join(', ')}</span>
                        <span className="flex items-center gap-1 text-green-400"><DollarSign className="w-3 h-3"/> ${r.totalPrice}</span>
                        <span className="flex items-center gap-1"><Phone className="w-3 h-3"/> {r.phone}</span>
                        <span className="flex items-center gap-1 truncate"><MapPin className="w-3 h-3"/> {r.location || 'N/A'}</span>
                      </div>
                      {/* UPDATED: WHATSAPP BUTTON (SAME FRAME) */}
                      {r.hasWhatsApp && (
                         <div className="mt-3">
                            <button 
                              onClick={() => {
                                const url = `https://api.whatsapp.com/send?phone=${r.phone.replace(/\D/g,'')}&text=${encodeURIComponent(
                                  `Hello ${r.name}, thank you for reserving with GoVibeMX! ðŸš\n\n` +
                                  `We're confirming your request:\n` +
                                  `â€¢ Trip: ${r.tripName || 'GoVibe Tour'}\n` +
                                  `â€¢ Date: ${r.tripDate || 'Upcoming'}\n` +
                                  `â€¢ Pick-up: ${r.location || "Not specified"}\n` +
                                  `â€¢ Seats: ${r.isPrivate ? 'PRIVATE VAN (All Seats)' : r.seats?.join(', ')}\n` +
                                  `â€¢ Total: $${r.totalPrice}\n\n` +
                                  `We will be with you shortly to confirm details!`
                                )}`;
                                window.top.location.href = url;
                              }}
                              className="inline-block px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-bold"
                            >
                               Chat on WhatsApp
                            </button>
                         </div>
                      )}
                    </div>
                    <div className="flex items-center gap-2 border-t md:border-t-0 md:border-l border-slate-700 pt-3 md:pt-0 md:pl-4">
                      <button onClick={() => setInfoData(r)} className="p-2 text-blue-400 hover:bg-blue-900/20 rounded-lg" title="View Details"><Info className="w-4 h-4"/></button>
                      <button onClick={() => handleStartEdit(r)} className="p-2 text-amber-400 hover:bg-amber-900/20 rounded-lg" title="Edit Booking"><Edit2 className="w-4 h-4"/></button>
                      {r.status === 'pending' && (
                        <>
                          <button onClick={() => handleUpdateStatus(r.id, 'confirmed')} className="p-2 text-green-400 hover:bg-green-900/20 rounded-lg" title="Confirm"><CheckCircle className="w-4 h-4"/></button>
                          <button onClick={() => handleUpdateStatus(r.id, 'cancelled')} className="p-2 text-slate-400 hover:bg-slate-700 rounded-lg" title="Cancel"><XCircle className="w-4 h-4"/></button>
                        </>
                      )}
                      {(r.status === 'confirmed' || r.status === 'cancelled') && (
                        <button onClick={() => handleUpdateStatus(r.id, 'pending')} className="p-2 text-slate-500 hover:text-white hover:bg-slate-700 rounded-lg" title="Undo Status"><RefreshCw className="w-4 h-4"/></button>
                      )}
                      <button onClick={(e) => requestDelete(e, r.id)} className="p-2 text-red-500 hover:bg-red-900/20 rounded-lg" title="Delete"><Trash2 className="w-4 h-4"/></button>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </main>
      )}
    </div>
  );
}

const root = createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
