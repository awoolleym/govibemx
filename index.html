<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoVibe Widget</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18.2.0","react-dom/client":"https://esm.sh/react-dom@18.2.0/client","firebase/app":"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js","firebase/auth":"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js","firebase/database":"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js","lucide-react":"https://esm.sh/lucide-react@0.294.0"}}
</script>
<style>
/* SEAT STYLES */
.gv-seat {
  width: 55px; height: 55px; 
  background: #1e293b; 
  border-radius: 8px; 
  border: 2px solid #334155;
  display: flex; flex-direction: column; 
  align-items: center; justify-content: center; 
  cursor: pointer;
  transition: all 0.2s; 
  position: relative;
  user-select: none;
  margin: 2px;
}
.gv-seat:hover { transform: translateY(-2px); border-color: #94a3b8; }
.gv-seat:active { transform: scale(0.95); }
.gv-seat strong { font-size: 13px; color: white; line-height: 1; }
.gv-seat span { font-size: 8px; opacity: 0.7; color: #cbd5e1; margin-top: 2px; }

/* TOOLTIP */
.seat-tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 10;
  margin-bottom: 5px;
}
.gv-seat:hover .seat-tooltip { opacity: 1; }

/* SEAT TYPES */
.seat-driver { background: #312e81; border-color: #4338ca; cursor: default; opacity: 0.8; }

/* VIP: Purple Scheme */
.seat-vip { border-color: #a855f7 !important; color: #a855f7 !important; }
.seat-vip strong { color: #d8b4fe !important; }

/* STANDARD: Green Scheme */
.seat-standard { border-color: #10b981 !important; color: #10b981 !important; }

/* STATES */
.seat-selected { background: #2563eb !important; border-color: #3b82f6 !important; color: white !important; box-shadow: 0 0 10px rgba(37,99,235,0.5); }
.seat-selected strong, .seat-selected span { color: white !important; }

/* SOLD: Red */
.seat-sold { background: #ef4444 !important; border-color: #ef4444 !important; opacity: 0.4; cursor: not-allowed; }
.seat-sold strong { color: white !important; opacity: 0.5; }

/* HOLD: Orange */
.seat-hold { background: #f97316 !important; border-color: #f97316 !important; opacity: 0.8; cursor: not-allowed; }
.seat-hold strong { color: white !important; opacity: 0.8; }

/* BLOCK (Admin Manual Block): Gray */
.seat-block { background: #475569 !important; border-color: #64748b !important; opacity: 0.9; }

.price-badge { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { 0% {transform: scale(0.8); opacity: 0} 100% {transform: scale(1); opacity: 1} }

/* ALARM ANIMATION */
@keyframes bell-shake {
  0% { transform: rotate(0); }
  15% { transform: rotate(5deg); }
  30% { transform: rotate(-5deg); }
  45% { transform: rotate(4deg); }
  60% { transform: rotate(-4deg); }
  75% { transform: rotate(2deg); }
  85% { transform: rotate(-2deg); }
  100% { transform: rotate(0); }
}
.animate-bell { animation: bell-shake 2s infinite; }
</style>
</head>
<body>

<!-- Safety Loader -->
<div id="root" class="min-h-[600px] bg-slate-900 flex items-center justify-center text-white p-4">
  <div id="loader-content" class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
    <p class="text-lg" id="loading-text">Initializing GoVibeMX...</p>
    <p id="error-display" class="text-red-400 text-sm mt-4 hidden"></p>
  </div>
</div>

<!-- Global Error Trap -->
<script>
  window.onerror = function(msg, url, line, col, error) {
    const el = document.getElementById('error-display');
    const spin = document.querySelector('.animate-spin');
    if(el) {
      el.innerHTML = `<strong>System Error:</strong><br/>${msg}`;
      el.classList.remove('hidden');
      if(spin) spin.style.display = 'none';
    }
    return false;
  };
</script>

<!-- MAIN APP SCRIPT -->
<script type="text/babel" data-type="module">
import React, { useState, useEffect, useMemo } from 'react';
import { createRoot } from 'react-dom/client';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getDatabase, ref, onValue, push, update, remove, set } from 'firebase/database';
import { 
  Calendar, Clock, Users, CheckCircle, XCircle, Trash2, RefreshCw, 
  LayoutDashboard, MapPin, MessageCircle, Phone, Mail, DollarSign, 
  Settings, Lock, AlertCircle, Plus, Edit2, Save, Armchair, Info, 
  Wifi, Coffee, CreditCard, Loader2, AlertTriangle, HelpCircle, Send, Home, Timer, 
  Bell, BellOff
} from 'lucide-react';

// --- CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyAqFnjf1i-8Qm95Xzp98FFO0ABUxb7hzn4",
    authDomain: "govibebooking.firebaseapp.com",
    databaseURL: "https://govibebooking-default-rtdb.firebaseio.com",
    projectId: "govibebooking",
    storageBucket: "govibebooking.firebasestorage.app",
    messagingSenderId: "1043728861046",
    appId: "1:1043728861046:web:2c1c2ac6aea814d6c99c57"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app, firebaseConfig.databaseURL);
const ALL_SEATS = ['seat1', 'seat2', 'seat3', 'seat4', 'seat5', 'seat6'];

// Helper: Next Saturday
const getNextSaturday = () => {
    const d = new Date();
    d.setDate(d.getDate() + (6 - d.getDay() + 7) % 7);
    d.setHours(8, 0, 0, 0);
    return d.getTime();
};

const toLocalISOString = (timestamp) => {
    if (!timestamp) return "";
    const date = new Date(timestamp);
    const offset = date.getTimezoneOffset() * 60000;
    return new Date(date.getTime() - offset).toISOString().slice(0, 16);
};

// --- AUDIO ALARM SYSTEM ---
const playAlertSound = () => {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, ctx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1); 
        
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
    } catch (e) {
        console.error("Audio Playback Failed", e);
    }
};

// --- WHATSAPP LINK BUILDERS ---
const getWhatsAppUrl = (r) => {
    const message = `Hello ${r.name}, thank you for reserving with GoVibeMX! ðŸš\n\n` +
                    `We're confirming your request:\n` +
                    `â€¢ Trip: ${r.tripName || 'GoVibe Tour'}\n` +
                    `â€¢ Date: ${r.tripDate || 'Upcoming'}\n` +
                    `â€¢ Pick-up: ${r.location || "Not specified"}\n` +
                    `â€¢ Seats: ${r.isPrivate ? 'PRIVATE VAN (All Seats)' : r.seats?.join(', ')}\n` +
                    `â€¢ Total: $${r.totalPrice}\n\n` +
                    `We will be with you shortly to confirm details!`;
    return `https://api.whatsapp.com/send?phone=${r.phone.replace(/\D/g, '')}&text=${encodeURIComponent(message)}`;
};

const getInquiryUrl = (i) => {
    const msg = `Hi ${i.name}, regarding your inquiry about ${i.source}:`;
    return `https://api.whatsapp.com/send?phone=${i.phone.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`;
};

// --- HELPER: POPUP LAUNCHER ---
const launchPopup = (e, url) => {
    e.preventDefault();
    const w = window.open(url, 'WhatsApp', 'width=800,height=600,menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes');
    if(!w) {
        alert("Please allow popups for this site to open WhatsApp chat.");
    }
};


function App() {
    // --- STATE ---
    const [user, setUser] = useState(null);
    const [reservations, setReservations] = useState([]);
    const [inquiries, setInquiries] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [loading, setLoading] = useState(true);
    const [loadingMsg, setLoadingMsg] = useState("Authenticating...");
    const [viewMode, setViewMode] = useState('widget'); 

    // Admin
    const [isAdmin, setIsAdmin] = useState(false);
    const [showAdminLogin, setShowAdminLogin] = useState(false);
    const [adminPassword, setAdminPassword] = useState('');
    const [authError, setAuthError] = useState(null);
    const [filterStatus, setFilterStatus] = useState('ALL');

    // App Data
    const [selectedSeats, setSelectedSeats] = useState([]);
    const [isPrivateMode, setIsPrivateMode] = useState(false);
    const [showBookingModal, setShowBookingModal] = useState(false);
    const [showInquiryModal, setShowInquiryModal] = useState(false);
    const [showSuccessModal, setShowSuccessModal] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [submitError, setSubmitError] = useState(null);
    const [editingBookingId, setEditingBookingId] = useState(null);
    const [infoData, setInfoData] = useState(null);
    const [confirmData, setConfirmData] = useState(null);
    
    // Alarm
    const [isMuted, setIsMuted] = useState(true);
    const [hasPending, setHasPending] = useState(false);

    const [config, setConfig] = useState({
        // DEFAULT NEW PRICING
        vipPrice: 1250,
        windowPrice: 1100,
        middlePrice: 950,
        privateOverridePrice: 0, // Manual override if > 0
        // DEFAULT GROUP DISCOUNTS
        discounts: { 2: 5, 3: 10, 4: 12, 5: 15, 6: 20 },
        // UPDATED: MINIMUM PP TABLE 
        minPerPerson: { 1: 3700, 2: 1850, 3: 1250, 4: 925, 5: 740, 6: 620 },
        
        tripName: 'TEOTIHUACÃN â˜€ï¸',
        tripDate: 'Saturday 8:00 AM',
        tripTimestamp: getNextSaturday(),
        noticeText: 'Meeting: Angel (15m early).\n(Premium Leather)',
        
        // UPDATED OPERATING COSTS (1200 Total)
        fuelCost: 200,
        tollCost: 220,
        parkingCost: 100,
        amenitiesCost: 200,
        laborCost: 0, 
        vehicleCost: 480, 
        otherCost: 0,
        targetProfit: 2500
    });

    const [formData, setFormData] = useState({
        name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '', message: ''
    });

    const [timeLeft, setTimeLeft] = useState("");

    // --- EFFECTS ---
    useEffect(() => {
        // Safety Timeout
        const safetyTimer = setTimeout(() => {
            if(loading) {
                console.warn("Forcing load due to timeout");
                setLoading(false);
            }
        }, 4000);

        // Auth
        setLoadingMsg("Signing in...");
        signInAnonymously(auth).then(() => {
            setLoadingMsg("Connecting to Database...");
        }).catch(e => {
            if (e.code === 'auth/operation-not-allowed') setAuthError("Enable Anonymous Auth in Firebase Console.");
            else setAuthError(e.message);
            setLoading(false);
        });

        onAuthStateChanged(auth, u => {
            if (u) { setUser(u); setAuthError(null); }
            else { setUser(null); }
        });

        onValue(ref(db, ".info/connected"), snap => setIsConnected(!!snap.val()));
        onValue(ref(db, "config"), snap => { if (snap.val()) setConfig(prev => ({...prev, ...snap.val()})); });
        
        onValue(ref(db, 'bookings'), snap => {
            const data = snap.val();
            const list = [];
            if (data) Object.keys(data).forEach(k => list.push({ id: k, ...data[k] }));
            list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            setReservations(list);
            setLoading(false);
        }, (err) => {
            console.error("DB Error", err);
            setLoading(false);
        });

        onValue(ref(db, 'inquiries'), snap => {
            const data = snap.val();
            const list = [];
            if (data) Object.keys(data).forEach(k => list.push({ id: k, ...data[k] }));
            list.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            setInquiries(list);
        });

        return () => clearTimeout(safetyTimer);
    }, []);

    // Alarm Logic
    useEffect(() => {
        const pendingExists = reservations.some(r => r.status === 'pending' || r.status === 'pending_review');
        setHasPending(pendingExists);
        if (pendingExists && !isMuted && isAdmin) {
            const interval = setInterval(() => playAlertSound(), 5000);
            return () => clearInterval(interval);
        }
    }, [reservations, isMuted, isAdmin]);

    // Countdown Logic
    useEffect(() => {
        const t = setInterval(() => {
            if (!config.tripTimestamp) return;
            const d = config.tripTimestamp - Date.now();
            if (d < 0) setTimeLeft("Departed");
            else setTimeLeft(`${Math.floor(d/864e5)}d ${Math.floor((d%864e5)/36e5)}h ${Math.floor((d%36e5)/6e4)}m`);
        }, 1000);
        return () => clearInterval(t);
    }, [config.tripTimestamp]);

    // --- COMPUTED ---
    const occupiedSeats = useMemo(() => {
        const map = {};
        reservations.forEach(r => {
            if (r.status === 'cancelled') return;
            if (editingBookingId && r.id === editingBookingId) return;
            let s = r.status === 'confirmed' ? 'sold' : 'hold';
            if (r.isManualBlock) s = 'block';
            if (r.status === 'pending_review') s = 'hold'; // Hold seats for review too

            if (Array.isArray(r.seats)) r.seats.forEach(id => map[id] = { status: s, name: r.name, id: r.id });
        });
        return map;
    }, [reservations, editingBookingId]);

    // CHECK IF ANY SEATS ARE TAKEN (For disabling private option)
    const hasActiveBookings = useMemo(() => {
        return Object.keys(occupiedSeats).length > 0;
    }, [occupiedSeats]);

    const quote = useMemo(() => {
        if (isPrivateMode) {
            // PRIVATE PRICING LOGIC: Uses Table unless overridden
            // Count for private mode is always 6 seats booked, but for pricing logic we use "user count" or default 1? 
            // Actually, private tour price is usually flat.
            // Requirement: "For 1 pax â†’ use the â€œminimum PP price for 1 paxâ€ Ã— 1"
            // But we don't ask pax count in private mode yet.
            // Let's assume user selected specific seats to indicate pax count, or just default to 6 pax logic?
            // "When the user selects â€œMake this tour private,â€ calculate the private tour price using the existing minimum-per-person values"
            // If they are on the map and select 2 seats then click private, we use count=2. 
            // If they just check private without selecting, we might assume 6?
            // Better: Use selectedSeats.length. If 0, assume 1 pax for pricing base or show minimum.
            
            const paxCount = selectedSeats.length > 0 ? selectedSeats.length : 1; 
            // If user checked private but didn't select seats, we assume 1 person booking private? 
            // Or usually private means they book the whole van.
            // Logic: "For 2 pax â†’ use the â€œminimum PP price for 2 paxâ€ Ã— 2"
            
            const minPP = config.minPerPerson ? parseInt(config.minPerPerson[paxCount] || 0) : 0;
            let calcPrivateTotal = minPP * paxCount;
            
            // Check for Override
            if (config.privateOverridePrice > 0) {
                calcPrivateTotal = parseInt(config.privateOverridePrice);
            }
            
            return { base: calcPrivateTotal, disc: 0, total: calcPrivateTotal, count: paxCount, isPriv: true };
        }

        let b = 0;
        selectedSeats.forEach(id => {
            if (['seat2', 'seat3'].includes(id)) b += parseInt(config.vipPrice);
            else if (id === 'seat5') b += parseInt(config.middlePrice);
            else b += parseInt(config.windowPrice);
        });
        const c = selectedSeats.length;
        let d = c >= 6 ? (config.discounts?.[6] || 20) : (config.discounts?.[c] || 0);
        return { base: b, disc: d, total: Math.round(b * (1 - d / 100)), count: c, isPriv: false };
    }, [selectedSeats, config, isPrivateMode]);

    // PROFITABILITY CALC
    const getProfitStats = (revenue) => {
        const baseCost = Number(config.fuelCost) + Number(config.tollCost) + Number(config.parkingCost) + Number(config.amenitiesCost) + Number(config.laborCost) + Number(config.vehicleCost) + Number(config.otherCost);
        const minRev = baseCost; 
        const targetRev = baseCost + Number(config.targetProfit);
        const profit = revenue - baseCost;
        
        let status = 'good'; // Green (>= Target)
        if (revenue < baseCost) status = 'loss'; // Red (Below cost)
        else if (revenue < targetRev) status = 'low'; // Yellow

        return { baseCost, targetRev, profit, status };
    };

    // --- HANDLERS ---
    const handleSeatClick = (id) => {
        if (viewMode === 'dashboard' && isAdmin) {
            const current = occupiedSeats[id];
            if (current) {
                if (confirm(`Release seat ${id}?`)) {
                    const r = reservations.find(x => x.id === current.id);
                    if (r && r.seats) {
                        const ns = r.seats.filter(s => s !== id);
                        if (ns.length === 0) remove(ref(db, `bookings/${current.id}`));
                        else update(ref(db, `bookings/${current.id}`), { seats: ns });
                    }
                }
            } else {
                const nr = push(ref(db, 'bookings'));
                set(nr, { name: "ADMIN BLOCK", seats: [id], status: 'hold', isManualBlock: true, createdAt: Date.now(), createdBy: user ? user.uid : 'admin' });
            }
            return;
        }

        if (occupiedSeats[id]) return;

        setSelectedSeats(prev => {
            const n = prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id];
            
            // AUTO-PRIVATE PROMPT LOGIC
            if (n.length === 6 && !isPrivateMode) {
                if (confirm("You selected all 6 seats. Would you like to book this tour as a private experience?")) {
                    setIsPrivateMode(true);
                }
            }
            
            return n;
        });
    };

    const handleSave = async (e) => {
        e.preventDefault();
        setSubmitError(null);
        setIsSubmitting(true);
        try {
            let u = user;
            if (!u) { const c = await signInAnonymously(auth); u = c.user; setUser(u); }
            
            // Safety check
            if (isPrivateMode && hasActiveBookings && !editingBookingId) {
                throw new Error("Cannot book private tour: Seats are already occupied.");
            }

            // Profitability Logic
            const stats = getProfitStats(quote.total);
            let bookingStatus = isAdmin ? 'confirmed' : 'pending';
            let finalPrivate = isPrivateMode;
            let finalTotal = quote.total;
            let currentCount = quote.count;

            const minPP = config.minPerPerson ? parseInt(config.minPerPerson[currentCount] || 0) : 0;
            const actualPP = currentCount > 0 ? quote.total / currentCount : 0;

            // Scenario A: 1-2 Passengers (Suggest Private)
            if (!isPrivateMode && !isAdmin && currentCount > 0 && currentCount <= 2 && actualPP < minPP) {
                 const privPrice = minPP * currentCount; // Suggested private price based on table
                 if (confirm(`For groups of ${currentCount}, we recommend upgrading to a Private Tour ($${privPrice}) to guarantee departure.\n\nUpgrade now?`)) {
                     finalPrivate = true;
                     finalTotal = privPrice;
                 } else {
                     if (quote.total < stats.baseCost) {
                         bookingStatus = 'pending_review';
                         alert("Note: Your booking revenue is below the minimum operating cost. It has been submitted for ADMIN REVIEW.");
                     }
                 }
            } 
            // Scenario B: 3+ Passengers (Check Minimum PP)
            else if (!isPrivateMode && !isAdmin && currentCount >= 3) {
                 if (actualPP < minPP) {
                     bookingStatus = 'pending_review';
                     alert("Your booking has been submitted for review. We will verify availability and contact you shortly.");
                 }
            }

            if (finalTotal < stats.baseCost && bookingStatus !== 'pending_review' && !isAdmin) {
                bookingStatus = 'pending_review';
            }

            const d = {
                ...formData,
                seats: finalPrivate ? ALL_SEATS : selectedSeats,
                totalPrice: finalTotal,
                originalPrice: quote.base,
                discount: quote.disc,
                isPrivate: finalPrivate,
                tripDate: config.tripDate,
                tripName: config.tripName,
                updatedAt: Date.now()
            };

            if (editingBookingId) {
                await update(ref(db, `bookings/${editingBookingId}`), d);
                alert("Updated!");
                setEditingBookingId(null);
                if (isAdmin) setViewMode('dashboard');
            } else {
                await set(push(ref(db, 'bookings')), { ...d, status: bookingStatus, createdAt: Date.now(), createdBy: u.uid });
                if(bookingStatus !== 'pending_review') setShowSuccessModal(true);
            }
            setShowBookingModal(false);
            setSelectedSeats([]);
            setIsPrivateMode(false);
            setFormData({ name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '' });
        } catch (x) {
            setSubmitError(x.message);
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleInquirySubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
            await set(push(ref(db, 'inquiries')), { ...formData, status: 'NEW', timestamp: Date.now(), source: config.tripName });
            alert("Sent!");
            setShowInquiryModal(false);
            setFormData(p => ({ ...p, message: '' }));
        } catch (x) {
            alert(x.message);
        } finally {
            setIsSubmitting(false);
        }
    };

    // --- HELPERS ---
    const hIn = e => { const { name, value } = e.target; setFormData(p => ({ ...p, [name]: value })); };
    const hDate = e => { if (e.target.value) { const d = new Date(e.target.value); setConfig(p => ({ ...p, tripTimestamp: d.getTime(), tripDate: d.toLocaleString('en-US', { weekday: 'long', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) })); } };
    
    const openWhatsApp = (r) => {
        const t = `Hello ${r.name}, thank you for reserving with GoVibeMX! ðŸš\n\nWe're confirming your request:\nâ€¢ Trip: ${r.tripName}\nâ€¢ Date: ${r.tripDate}\nâ€¢ Pick-up: ${r.location}\nâ€¢ Seats: ${r.isPrivate ? 'PRIVATE' : r.seats?.join(', ')}\nâ€¢ Total: $${r.totalPrice}`;
        window.top.location.href = `https://api.whatsapp.com/send?phone=${r.phone.replace(/\D/g, '')}&text=${encodeURIComponent(t)}`;
    };

    const startEdit = (r) => {
        setEditingBookingId(r.id);
        setSelectedSeats(r.seats || []);
        setIsPrivateMode(r.isPrivate || false);
        setFormData({ name: r.name || '', phone: r.phone || '', email: r.email || '', location: r.location || '', contactMethod: r.contactMethod || 'WhatsApp', hasWhatsApp: r.hasWhatsApp, notes: r.notes || '' });
        setViewMode('widget');
    };

    const handleStartNewBooking = () => {
        setEditingBookingId(null);
        setSelectedSeats([]);
        setIsPrivateMode(false);
        setFormData({ name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '' });
        setViewMode('widget'); 
    };

    const deleteBooking = async () => {
        if (!confirmData) return;
        try {
            if (confirmData.type === 'del') await remove(ref(db, `bookings/${confirmData.id}`));
            else if (confirmData.type === 'wipe') await remove(ref(db, 'bookings'));
            setConfirmData(null);
        } catch (e) { alert(e.message); }
    };

    const toggleMute = () => { setIsMuted(!isMuted); };

    // --- RENDER HELPERS ---
    const Seat = ({ id, label, sub, type, ia = true }) => {
        const d = occupiedSeats[id];
        const s = d ? d.status : null;
        let c = `gv-seat seat-${type}`;
        if (s === 'sold') c = 'gv-seat seat-sold';
        else if (s === 'hold') c = 'gv-seat seat-hold';
        else if (s === 'block') c = 'gv-seat seat-block';
        if (selectedSeats.includes(id)) c = 'gv-seat seat-selected';
        if (!ia) c += ' cursor-default';
        if (isAdmin && viewMode === 'dashboard') c += ' cursor-pointer ring-2 ring-white';
        
        let pr = 0;
        if (['seat2', 'seat3'].includes(id)) pr = config.vipPrice;
        else if (id === 'seat5') pr = config.middlePrice;
        else pr = config.windowPrice;

        return (
            <div onClick={ia || (isAdmin && viewMode === 'dashboard') ? () => handleSeatClick(id) : null} className={c}>
                <strong>{label}</strong><span>{sub}</span>
                <div className="seat-tooltip">{isAdmin && d ? d.name : (isPrivateMode ? 'Incl' : `$${pr}`)}</div>
            </div>
        );
    };

    const Map = ({ ia = true }) => (
        <>
            <div className="text-center mb-2 text-[10px] text-slate-500 uppercase">Front</div>
            <div className="flex justify-center gap-4 mb-4"><div className="gv-seat seat-driver"><span className="text-[10px] text-indigo-200 font-bold">DRIVER</span></div><Seat id="seat1" label="#1" sub="Co-Pilot" type="standard" ia={ia} /></div>
            <div className="flex justify-center gap-4 mb-4"><Seat id="seat2" label="#2" sub="Capt" type="vip" ia={ia} /><Seat id="seat3" label="#3" sub="Capt" type="vip" ia={ia} /></div>
            <div className="text-center mb-2 text-[10px] text-slate-500 uppercase">Bench</div>
            <div className="flex justify-center gap-4 mb-6"><Seat id="seat4" label="#4" sub="Win" type="standard" ia={ia} /><Seat id="seat5" label="#5" sub="Mid" type="standard" ia={ia} /><Seat id="seat6" label="#6" sub="Win" type="standard" ia={ia} /></div>
        </>
    );

    if (loading) {
        return (
            <div className="min-h-[600px] bg-slate-900 flex items-center justify-center text-white p-4">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
                    <p className="text-lg">{loadingMsg}</p>
                    {authError && <p className="text-red-400 text-sm mt-4 font-bold">{authError}</p>}
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-[600px] bg-slate-900 font-sans text-slate-100 relative pb-20">
            <div className="fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-slate-800 px-3 py-1 rounded border border-slate-700 shadow text-xs">
                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></div><span>{authError || (isConnected ? 'Online' : '...')}</span>
            </div>

            <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-20">
                <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2"><img src="https://img1.wsimg.com/isteam/ip/a2f36b16-54d7-45cc-96f6-48f6a722fb83/GoVibeAlta.png/:/rs=w:1344,h:600,cg:true,m/cr=w:1344,h:600/qt=q:95" className="h-10 object-contain" /></div>
                    <div className="flex bg-slate-700 p-1 rounded-lg items-center">
                        {isAdmin && viewMode === 'dashboard' && (
                            <button onClick={toggleMute} className={`mr-2 p-2 rounded-full transition-colors ${isMuted ? 'text-red-400 bg-red-900/20' : 'text-green-400 bg-green-900/20'} ${hasPending && !isMuted ? 'animate-bell' : ''}`} title={isMuted ? "Unmute Alarm" : "Mute Alarm"}>
                                {isMuted ? <BellOff className="w-4 h-4" /> : <Bell className="w-4 h-4" />}
                            </button>
                        )}
                        <button onClick={() => { setViewMode('widget'); setEditingBookingId(null); setSelectedSeats([]); setIsPrivateMode(false); }} className={`px-4 py-1 rounded text-sm ${viewMode === 'widget' ? 'bg-slate-600 text-white' : 'text-slate-400'}`}>Widget</button>
                        <button onClick={() => isAdmin ? setViewMode('dashboard') : setShowAdminLogin(true)} className={`flex items-center gap-2 px-4 py-1 rounded text-sm ${viewMode !== 'widget' ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}>{isAdmin ? <LayoutDashboard className="w-4 h-4" /> : <Lock className="w-4 h-4" />} Admin</button>
                    </div>
                </div>
            </header>

            {confirmData && <div className="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4"><div className="bg-slate-800 p-6 rounded border border-red-500 text-center"><AlertTriangle className="mx-auto mb-2 text-red-500" /><h3 className="text-lg font-bold mb-2">Confirm</h3><p className="text-sm text-slate-400 mb-6">{confirmData.title}</p><div className="flex gap-3"><button onClick={() => setConfirmData(null)} className="flex-1 bg-slate-700 p-2 rounded">Cancel</button><button onClick={deleteBooking} className="flex-1 bg-red-600 p-2 rounded">Yes</button></div></div></div>}

            {showAdminLogin && <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"><div className="bg-slate-800 p-8 rounded border border-slate-700 w-full max-w-sm"><h3 className="text-xl font-bold mb-4">Login</h3><form onSubmit={e => { e.preventDefault(); if (adminPassword === 'govibe123') { setIsAdmin(true); setShowAdminLogin(false); setViewMode('dashboard'); setAdminPassword(''); } else alert('Bad Pass') }}><input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-4" /><div className="flex gap-3"><button type="button" onClick={() => setShowAdminLogin(false)} className="flex-1 bg-slate-700 p-2 rounded">Cancel</button><button className="flex-1 bg-indigo-600 p-2 rounded">Login</button></div></form></div></div>}

            {viewMode === 'widget' && (
                <div className="p-4 flex justify-center w-full"><div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div className="bg-slate-800/50 p-6 rounded-2xl border border-slate-700 order-2 md:order-1 space-y-4">
                        <div><h2 className="text-3xl font-bold">{config.tripName}</h2><div className="flex items-center gap-2 text-indigo-400 mt-2"><Calendar className="w-4 h-4" /><span>{config.tripDate}</span></div><div className="flex items-center gap-2 text-amber-400 text-sm mt-1 font-mono"><Timer className="w-4 h-4" /><span>{timeLeft || "..."}</span></div></div>
                        {editingBookingId && <div className="bg-amber-900/30 border border-amber-500 p-2 rounded text-amber-200 text-sm font-bold flex gap-2"><Edit2 className="w-4 h-4" /> EDITING</div>}
                        <div className="bg-slate-900/50 p-4 rounded border border-slate-700/50"><p className="text-sm whitespace-pre-wrap">{config.noticeText}</p></div>
                        <div className="flex gap-4 text-xs text-slate-400 pt-2"><span className="flex gap-1"><Wifi className="w-4 h-4" /> WiFi</span><span className="flex gap-1"><Coffee className="w-4 h-4" /> Snacks</span><span className="flex gap-1"><CreditCard className="w-4 h-4" /> Cards</span></div>
                        <button onClick={() => setShowInquiryModal(true)} className="w-full border border-slate-600 text-slate-300 py-2 rounded text-sm hover:bg-slate-800 flex items-center justify-center gap-2"><HelpCircle className="w-4 h-4" /> Inquire Here</button>
                        <div className="mt-6 p-6 bg-slate-900 rounded border border-slate-700 text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500"></div>{quote.count > 0 || isPrivateMode ? (<div className="price-badge"><div className="text-slate-400 text-xs uppercase">{isPrivateMode ? "PRIVATE" : "Total"}</div><div className="flex justify-center items-center gap-2">{!isPrivateMode && quote.disc > 0 && <span className="line-through text-slate-500">${quote.base}</span>}<div className="text-3xl font-bold text-cyan-400">${quote.total}</div></div>{isPrivateMode ? <div className="text-xs text-indigo-400 font-bold">FULL VAN</div> : (quote.disc > 0 && <div className="text-xs text-green-400">SAVED {quote.disc}%</div>)}</div>) : <div className="text-slate-500 text-sm">Select seats</div>}</div>
                    </div>
                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl order-1 md:order-2">
                        <Map ia={!isPrivateMode} />
                        <div className="flex justify-center gap-2 text-[10px] text-slate-400 border-t border-slate-700 pt-4 mb-4 flex-wrap"><span className="flex gap-1"><div className="w-3 h-3 rounded bg-indigo-500"></div>Open</span><span className="flex gap-1"><div className="w-3 h-3 rounded border border-a855f7"></div>VIP</span><span className="flex gap-1"><div className="w-3 h-3 rounded bg-blue-600"></div>You</span><span className="flex gap-1"><div className="w-3 h-3 rounded bg-f97316"></div>Hold</span><span className="flex gap-1"><div className="w-3 h-3 rounded bg-red-500"></div>Sold</span></div>
                        <button disabled={!quote.count && !isPrivateMode} onClick={() => setShowBookingModal(true)} className={`w-full py-4 rounded font-bold text-lg ${quote.count || isPrivateMode ? (editingBookingId ? 'bg-amber-600' : 'bg-indigo-600') : 'bg-slate-700 text-slate-500'}`}>{quote.count || isPrivateMode ? (editingBookingId ? 'Modify' : 'Reserve') : 'Select Seats'}</button>
                        {editingBookingId && <button onClick={() => { setEditingBookingId(null); setSelectedSeats([]); if (isAdmin) setViewMode('dashboard') }} className="w-full mt-2 text-xs text-slate-400">Cancel Edit</button>}
                        {isPrivateMode && <button onClick={() => { setIsPrivateMode(false); setSelectedSeats([]) }} className="w-full mt-2 text-xs text-amber-500 hover:text-amber-400">Cancel Private Mode</button>}
                    </div>
                </div></div>
            )}

            {showInquiryModal && <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div className="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-6 relative"><button onClick={() => setShowInquiryModal(false)} className="absolute top-4 right-4"><XCircle className="text-slate-400 hover:text-white" /></button><h3 className="text-xl font-bold mb-4">Inquire</h3><form onSubmit={handleInquirySubmit} className="space-y-4"><input required name="name" value={formData.name} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Name" /><div className="grid grid-cols-2 gap-2"><select name="contactMethod" value={formData.contactMethod} onChange={hIn} className="bg-slate-900 border border-slate-700 rounded p-2"><option>WhatsApp</option><option>Email</option></select><input required name="phone" value={formData.phone} onChange={hIn} className="bg-slate-900 border border-slate-700 rounded p-2" placeholder="Phone" /></div><input type="email" name="email" value={formData.email} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Email" /><textarea required name="message" value={formData.message} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Message" rows="3" /><button disabled={isSubmitting} className="w-full bg-indigo-600 p-2 rounded font-bold">{isSubmitting ? "..." : "Send"}</button></form></div></div>}

            {showBookingModal && <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div className="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-6 relative"><button onClick={() => setShowBookingModal(false)} className="absolute top-4 right-4"><XCircle className="text-slate-400 hover:text-white" /></button><h3 className="text-xl font-bold mb-4">{editingBookingId ? 'Edit' : 'Confirm'}</h3><form onSubmit={handleSave} className="space-y-4">
                {submitError && <div className="bg-red-900/30 border border-red-500 text-red-200 text-xs p-2 rounded">{submitError}</div>}
                <div className="bg-slate-900/50 p-3 rounded border border-slate-700 text-sm flex justify-between"><span>Seats: {isPrivateMode ? 'ALL' : selectedSeats.join(',')}</span><span className="text-cyan-400 font-bold">${quote.total}</span></div>
                
                {/* PRIVATE TOUR LOGIC WITH DISABLE CHECK */}
                {!editingBookingId && !hasActiveBookings && (
                  <div className="flex gap-2 bg-indigo-900/20 border border-indigo-500/30 p-2 rounded">
                    <input type="checkbox" checked={isPrivateMode} onChange={e => {setIsPrivateMode(e.target.checked); if(!e.target.checked) setSelectedSeats([]);}} />
                    <div className="text-sm"><strong>Private Tour</strong><p className="text-xs text-slate-400">Full van ${config.privatePrice}</p></div>
                  </div>
                )}
                {!editingBookingId && hasActiveBookings && (
                  <div className="bg-slate-800 border border-slate-600 p-2 rounded text-xs text-slate-400 italic">
                    Private option unavailable (seats already sold).
                  </div>
                )}

                <div><label className="text-xs text-slate-400 block mb-1">Full Name</label><input required name="name" value={formData.name} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Name" /></div>
                <div className="grid grid-cols-2 gap-2">
                   <div><label className="text-xs text-slate-400 block mb-1">Preferred Contact Method</label><select name="contactMethod" value={formData.contactMethod} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2"><option>WhatsApp</option><option>Phone</option><option>Email</option></select></div>
                   <div><label className="text-xs text-slate-400 block mb-1">Phone</label><input required name="phone" value={formData.phone} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Phone" /></div>
                </div>
                <div><label className="text-xs text-slate-400 block mb-1">Pickup Location</label><input name="location" value={formData.location} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Pickup / Hotel" /></div>
                <div><label className="text-xs text-slate-400 block mb-1">Email (Optional)</label><input type="email" name="email" value={formData.email} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Email (Optional)" /></div>
                {isAdmin && <div><label className="text-xs text-slate-400 block mb-1">Notes</label><textarea name="notes" value={formData.notes} onChange={hIn} className="w-full bg-slate-900 border border-slate-700 rounded p-2" placeholder="Notes" /></div>}
                <button disabled={isSubmitting} className="w-full bg-indigo-600 p-3 rounded font-bold">{isSubmitting ? <Loader2 className="w-4 h-4 animate-spin inline" /> : (editingBookingId ? 'Update' : 'Confirm')}</button></form></div></div>}

            {showSuccessModal && <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4"><div className="text-center"><CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" /><h2 className="text-2xl font-bold">Received!</h2><p className="text-slate-400 mb-4">Seats ON HOLD.</p><button onClick={() => setShowSuccessModal(false)} className="bg-slate-700 px-6 py-2 rounded">Close</button></div></div>}

            {infoData && <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4"><div className="bg-slate-800 w-full max-w-sm rounded-xl border border-slate-700 p-6 relative"><button onClick={() => setInfoData(null)} className="absolute top-4 right-4"><XCircle className="text-slate-400 hover:text-white" /></button><h3 className="text-lg font-bold text-white mb-4">Booking Details</h3><div className="space-y-2 text-sm text-slate-300">
                <p><strong>Name:</strong> {infoData.name}</p><p><strong>Contact:</strong> {infoData.phone} ({infoData.contactMethod})</p>{infoData.email && <p><strong>Email:</strong> {infoData.email}</p>}<p><strong>Loc:</strong> {infoData.location}</p>
                <div className="bg-slate-900 p-2 rounded text-xs"><p>Type: {infoData.isPrivate ? 'Private' : 'Shared'}</p><p>Seats: {infoData.seats?.join(', ')}</p><p className="font-bold text-white border-t border-slate-700 mt-1 pt-1">Total: ${infoData.totalPrice}</p></div>{infoData.notes && <div className="bg-amber-900/20 p-2 rounded text-xs text-amber-200">Note: {infoData.notes}</div>}<div className="text-[10px] text-slate-600 text-center pt-2">ID: {infoData.id}</div></div></div></div>}

            {isAdmin && (viewMode === 'dashboard' || viewMode === 'settings' || viewMode === 'inquiries') && (
                <main className="max-w-6xl mx-auto px-4 py-8"><div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-bold">Admin</h2><div className="flex gap-2">
                    <button onClick={() => setViewMode(viewMode === 'inquiries' ? 'dashboard' : 'inquiries')} className="px-3 py-1 rounded border bg-slate-800"><HelpCircle className="w-4 h-4" /></button><button onClick={() => setViewMode(viewMode === 'settings' ? 'dashboard' : 'settings')} className="px-3 py-1 rounded border bg-slate-800"><Settings className="w-4 h-4" /></button><button onClick={() => setViewMode('dashboard')} className="px-3 py-1 rounded bg-slate-800 text-white"><Home className="w-4 h-4" /></button><button onClick={() => { setConfirmData({ type: 'wipe', title: 'WIPE ALL?' }) }} className="px-3 py-1 rounded bg-red-900/50 text-red-400"><Trash2 className="w-4 h-4" /></button><button onClick={() => { setIsAdmin(false); setViewMode('widget') }} className="px-3 py-1 rounded bg-slate-800">LogOut</button></div></div>
                    {viewMode === 'settings' ? (<div className="bg-slate-800 p-6 rounded border border-slate-700 max-w-lg mx-auto space-y-4">
                        <h3 className="font-bold border-b pb-2">Trip</h3><div><label className="text-xs text-slate-400">Name</label><input className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.tripName} onChange={e => setConfig({ ...config, tripName: e.target.value })} /></div><div><label className="text-xs text-slate-400">Date</label><input type="datetime-local" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={toLocalISOString(config.tripTimestamp)} onChange={hDate} /></div><div><label className="text-xs text-slate-400">Notice</label><textarea className="w-full bg-slate-900 border border-slate-600 rounded p-1" rows="2" value={config.noticeText} onChange={e => setConfig({ ...config, noticeText: e.target.value })} /></div>
                        
                        {/* SEAT TIERS */}
                        <h3 className="font-bold border-b pb-2 pt-4">Seat Tier Pricing</h3>
                        <div className="grid grid-cols-3 gap-2">
                           <div><label className="text-xs text-slate-400 block mb-1">VIP (Front)</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.vipPrice} onChange={e => setConfig({...config, vipPrice: e.target.value})} /></div>
                           <div><label className="text-xs text-slate-400 block mb-1">Window</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.windowPrice} onChange={e => setConfig({...config, windowPrice: e.target.value})} /></div>
                           <div><label className="text-xs text-slate-400 block mb-1">Middle</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.middlePrice} onChange={e => setConfig({...config, middlePrice: e.target.value})} /></div>
                        </div>

                        {/* MINIMUM PER PERSON */}
                        <h3 className="font-bold border-b pb-2 pt-4">Group Minimum Pricing (Per Person)</h3>
                        <div className="grid grid-cols-3 gap-2">
                           {[1,2,3,4,5,6].map(n => (
                              <div key={n}><label className="text-xs text-slate-400 block mb-1">{n} Pax Min</label>
                                 <input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1 text-amber-400" 
                                   value={config.minPerPerson ? config.minPerPerson[n] : 0} 
                                   onChange={e => setConfig({...config, minPerPerson: {...config.minPerPerson, [n]: e.target.value}})} 
                                 />
                              </div>
                           ))}
                        </div>

                        {/* PRIVATE & COSTS */}
                        <h3 className="font-bold border-b pb-2 pt-4">Operational Costs & Private</h3>
                        <div className="grid grid-cols-2 gap-3 mb-2"><div><label className="text-xs text-slate-400 block mb-1">Private Tour Price Override (Optional)</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1 text-indigo-400" value={config.privateOverridePrice} onChange={e => setConfig({...config, privateOverridePrice: e.target.value})} /></div></div>
                        <div className="grid grid-cols-3 gap-2 text-xs text-slate-400">
                           <div>Fuel<input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.fuelCost} onChange={e => setConfig({...config, fuelCost: e.target.value})} /></div>
                           <div>Tolls<input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.tollCost} onChange={e => setConfig({...config, tollCost: e.target.value})} /></div>
                           <div>Parking<input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.parkingCost} onChange={e => setConfig({...config, parkingCost: e.target.value})} /></div>
                           <div>Amenity<input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.amenitiesCost} onChange={e => setConfig({...config, amenitiesCost: e.target.value})} /></div>
                           <div>Labor<input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.laborCost} onChange={e => setConfig({...config, laborCost: e.target.value})} /></div>
                           <div>Vehicle<input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1" value={config.vehicleCost} onChange={e => setConfig({...config, vehicleCost: e.target.value})} /></div>
                        </div>
                        <button onClick={() => update(ref(db, 'config'), config).then(() => alert('Saved'))} className="w-full bg-green-600 p-2 rounded font-bold mt-4"><Save className="w-4 h-4 inline" /> Save Configuration</button></div>) : viewMode === 'inquiries' ? (<div className="space-y-4">{inquiries.length === 0 ? <div className="text-center text-slate-500">No Inquiries</div> : inquiries.map(i => <div key={i.id} className="bg-slate-800 p-4 rounded border border-slate-700"><div className="flex justify-between"><div><h4 className="font-bold">{i.name} <span className="text-[10px] bg-slate-600 px-1 rounded">{i.status}</span></h4><p className="text-sm text-slate-400">{i.message}</p><div className="text-xs text-slate-500 mt-1">{new Date(i.timestamp).toLocaleString()} â€¢ {i.phone}</div></div><div className="flex gap-2"><button onClick={() => openInquiryWhatsApp(i)} className="bg-green-600 p-2 rounded text-white"><MessageCircle className="w-4 h-4" /></button>{i.status === 'NEW' && <button onClick={() => update(ref(db, `inquiries/${i.id}`), { status: 'READ' })} className="bg-slate-600 p-2 rounded text-xs">Read</button>}</div></div></div>)}</div>) : (<>
                        <div className="flex gap-2 mb-4 text-xs">
                           {['ALL', 'confirmed', 'pending', 'pending_review', 'cancelled'].map(s => (
                             <button key={s} onClick={() => setFilterStatus(s)} className={`px-3 py-1 rounded border ${filterStatus === s ? 'bg-white text-slate-900' : 'bg-slate-800 text-slate-400 border-slate-700'}`}>{s.toUpperCase().replace('_', ' ')}</button>
                           ))}
                        </div>
                        <div className="space-y-3">{reservations.filter(r => filterStatus === 'ALL' || r.status === filterStatus).map(r => {
                             const stats = getProfitStats(r.totalPrice);
                             let borderClass = stats.status === 'loss' ? 'border-l-red-500' : stats.status === 'low' ? 'border-l-yellow-500' : 'border-l-green-500';
                             return (
                               <div key={r.id} className={`bg-slate-800 rounded p-4 border shadow-sm flex flex-col md:flex-row justify-between gap-4 border-l-4 ${borderClass}`}>
                                <div className="flex-1"><div className="flex items-center gap-2 mb-1"><h3 className="font-bold">{r.name}</h3>{r.status === 'pending_review' ? <span className="text-[10px] bg-orange-600 px-2 rounded text-white animate-pulse">REVIEW NEEDED</span> : (r.isPrivate ? <span className="text-[10px] bg-indigo-600 px-2 rounded text-white">PRIVATE</span> : <span className="text-[10px] bg-slate-700 px-2 rounded uppercase">{r.status}</span>)}</div><div className="text-sm text-slate-400 grid grid-cols-2 gap-2"><span>{r.isPrivate ? 'ALL' : r.seats?.join(',')}</span><span className="text-green-400">${r.totalPrice}</span><span>{r.phone}</span><span className="truncate">{r.location}</span></div>
                                <div className="mt-2 text-[10px] flex gap-2 bg-slate-900 p-1 rounded w-fit"><span>Cost: ${stats.baseCost}</span> <span className={stats.profit < 0 ? 'text-red-400' : 'text-green-400'}>Profit: ${stats.profit}</span></div>
                                {r.hasWhatsApp && <div className="mt-2"><button onClick={() => openWhatsApp(r)} className="inline-flex items-center gap-2 bg-green-600 px-3 py-1 rounded text-xs font-bold"><MessageCircle className="w-3 h-3" /> WhatsApp</button></div>}</div><div className="flex gap-2 items-center"><button onClick={() => setInfoData(r)} className="p-2 text-blue-400 border border-blue-900/50 rounded bg-blue-900/20"><Info className="w-4 h-4" /></button><button onClick={() => startEdit(r)} className="p-2 text-amber-400 border border-amber-900/50 rounded bg-amber-900/20"><Edit2 className="w-4 h-4" /></button>{r.status === 'pending_review' ? <><button onClick={() => update(ref(db, `bookings/${r.id}`), { status: 'confirmed' })} className="p-2 text-green-400 border border-green-500 rounded">Approve</button><button onClick={() => update(ref(db, `bookings/${r.id}`), { status: 'cancelled' })} className="p-2 text-red-400 border border-red-500 rounded">Reject</button></> : (r.status === 'pending' && <><button onClick={() => update(ref(db, `bookings/${r.id}`), { status: 'confirmed' })} className="p-2 text-green-400"><CheckCircle /></button><button onClick={() => update(ref(db, `bookings/${r.id}`), { status: 'cancelled' })} className="p-2 text-slate-500"><XCircle /></button></>)}{(r.status === 'confirmed' || r.status === 'cancelled') && <button onClick={() => update(ref(db, `bookings/${r.id}`), { status: 'pending' })} className="p-2 text-slate-500"><RefreshCw className="w-4 h-4" /></button>}<button onClick={() => setConfirmData({ type: 'del', id: r.id, title: "Delete?" })} className="p-2 text-red-500"><Trash2 className="w-4 h-4" /></button></div></div>
                             );
                        })}</div>
                    </>)}</main>)}
        </div>);
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
