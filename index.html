<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoVibe Widget</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18.2.0","react-dom/client":"https://esm.sh/react-dom@18.2.0/client","firebase/app":"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js","firebase/auth":"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js","firebase/database":"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js","lucide-react":"https://esm.sh/lucide-react@0.294.0"}}
</script>
<style>
/* SEAT STYLES */
.gv-seat {
  width: 55px; height: 55px; 
  background: #1e293b; 
  border-radius: 8px; 
  border: 2px solid #334155;
  display: flex; flex-direction: column; 
  align-items: center; justify-content: center; 
  cursor: pointer;
  transition: all 0.2s; 
  position: relative;
  user-select: none;
  margin: 2px;
}
.gv-seat:hover { transform: translateY(-2px); border-color: #94a3b8; }
.gv-seat:active { transform: scale(0.95); }
.gv-seat strong { font-size: 13px; color: white; line-height: 1; }
.gv-seat span { font-size: 8px; opacity: 0.7; color: #cbd5e1; margin-top: 2px; }

/* TOOLTIP */
.seat-tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 10;
  margin-bottom: 5px;
}
.gv-seat:hover .seat-tooltip { opacity: 1; }

/* SEAT TYPES */
.seat-driver { background: #312e81; border-color: #4338ca; cursor: default; opacity: 0.8; }

/* VIP: Purple Scheme */
.seat-vip { border-color: #a855f7 !important; color: #a855f7 !important; }
.seat-vip strong { color: #d8b4fe !important; }

/* STANDARD: Green Scheme */
.seat-standard { border-color: #10b981 !important; color: #10b981 !important; }

/* STATES */
.seat-selected { background: #2563eb !important; border-color: #3b82f6 !important; color: white !important; box-shadow: 0 0 10px rgba(37,99,235,0.5); }
.seat-selected strong, .seat-selected span { color: white !important; }

/* SOLD: Red */
.seat-sold { background: #ef4444 !important; border-color: #ef4444 !important; opacity: 0.4; cursor: not-allowed; }
.seat-sold strong { color: white !important; opacity: 0.5; }

/* HOLD: Orange */
.seat-hold { background: #f97316 !important; border-color: #f97316 !important; opacity: 0.8; cursor: not-allowed; }
.seat-hold strong { color: white !important; opacity: 0.8; }

/* BLOCK (Admin Manual Block): Gray */
.seat-block { background: #475569 !important; border-color: #64748b !important; opacity: 0.9; }

.price-badge { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { 0% {transform: scale(0.8); opacity: 0} 100% {transform: scale(1); opacity: 1} }

/* ALARM ANIMATION */
@keyframes bell-shake {
  0% { transform: rotate(0); }
  15% { transform: rotate(5deg); }
  30% { transform: rotate(-5deg); }
  45% { transform: rotate(4deg); }
  60% { transform: rotate(-4deg); }
  75% { transform: rotate(2deg); }
  85% { transform: rotate(-2deg); }
  100% { transform: rotate(0); }
}
.animate-bell { animation: bell-shake 2s infinite; }
</style>
</head>
<body>

<!-- Safety Loader -->
<div id="root" class="min-h-[600px] bg-slate-900 flex items-center justify-center text-white p-4">
  <div id="loader-content" class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
    <p class="text-lg" id="loading-text">Initializing GoVibeMX...</p>
    <p id="error-display" class="text-red-400 text-sm mt-4 hidden"></p>
  </div>
</div>

<!-- Global Error Trap -->
<script>
  window.onerror = function(msg, url, line, col, error) {
    const el = document.getElementById('error-display');
    const spin = document.querySelector('.animate-spin');
    if(el) {
      el.innerHTML = `<strong>System Error:</strong><br/>${msg}`;
      el.classList.remove('hidden');
      if(spin) spin.style.display = 'none';
    }
    return false;
  };
</script>

<!-- MAIN APP SCRIPT -->
<script type="text/babel" data-type="module">
import React, { useState, useEffect, useMemo } from 'react';
import { createRoot } from 'react-dom/client';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getDatabase, ref, onValue, push, update, remove, set } from 'firebase/database';
import { 
  Calendar, Clock, Users, CheckCircle, XCircle, Trash2, RefreshCw, 
  LayoutDashboard, MapPin, MessageCircle, Phone, Mail, DollarSign, 
  Settings, Lock, AlertCircle, Plus, Edit2, Save, Armchair, Info, 
  Wifi, Coffee, CreditCard, Loader2, AlertTriangle, HelpCircle, Send, Home, Timer, 
  Bell, BellOff, Users2
} from 'lucide-react';

// --- CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyAqFnjf1i-8Qm95Xzp98FFO0ABUxb7hzn4",
    authDomain: "govibebooking.firebaseapp.com",
    databaseURL: "https://govibebooking-default-rtdb.firebaseio.com",
    projectId: "govibebooking",
    storageBucket: "govibebooking.firebasestorage.app",
    messagingSenderId: "1043728861046",
    appId: "1:1043728861046:web:2c1c2ac6aea814d6c99c57"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app, firebaseConfig.databaseURL);
const ALL_SEATS = ['seat1', 'seat2', 'seat3', 'seat4', 'seat5', 'seat6'];

// Helper: Next Saturday
const getNextSaturday = () => {
    const d = new Date();
    d.setDate(d.getDate() + (6 - d.getDay() + 7) % 7);
    d.setHours(8, 0, 0, 0);
    return d.getTime();
};

const toLocalISOString = (timestamp) => {
    if (!timestamp) return "";
    const date = new Date(timestamp);
    const offset = date.getTimezoneOffset() * 60000;
    return new Date(date.getTime() - offset).toISOString().slice(0, 16);
};

// --- AUDIO ALARM SYSTEM ---
const playAlertSound = () => {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, ctx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1); 
        
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
    } catch (e) {
        console.error("Audio Playback Failed", e);
    }
};

// --- WHATSAPP LINK BUILDERS ---
const getWhatsAppUrl = (r) => {
    const message = `Hello ${r.name}, thank you for reserving with GoVibeMX! ðŸš\n\n` +
                    `We're confirming your request:\n` +
                    `â€¢ Trip: ${r.tripName || 'GoVibe Tour'}\n` +
                    `â€¢ Date: ${r.tripDate || 'Upcoming'}\n` +
                    `â€¢ Pick-up: ${r.location || "Not specified"}\n` +
                    `â€¢ Seats: ${r.isPrivate ? 'PRIVATE VAN (All Seats)' : r.seats?.join(', ')}\n` +
                    `â€¢ Total: $${r.totalPrice}\n\n` +
                    `We will be with you shortly to confirm details!`;
    return `https://api.whatsapp.com/send?phone=${r.phone.replace(/\D/g, '')}&text=${encodeURIComponent(message)}`;
};

const getInquiryUrl = (i) => {
    const msg = `Hi ${i.name}, regarding your inquiry about ${i.source}:`;
    return `https://api.whatsapp.com/send?phone=${i.phone.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`;
};

// --- HELPER: POPUP LAUNCHER ---
const launchPopup = (e, url) => {
    e.preventDefault();
    const w = window.open(url, 'WhatsApp', 'width=800,height=600,menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes');
    if(!w) {
        alert("Please allow popups for this site to open WhatsApp chat.");
    }
};


function App() {
    // --- STATE ---
    const [user, setUser] = useState(null);
    const [reservations, setReservations] = useState([]);
    const [inquiries, setInquiries] = useState([]);
    const [isConnected, setIsConnected] = useState(false);
    const [loading, setLoading] = useState(true);
    const [loadingMsg, setLoadingMsg] = useState("Authenticating...");
    const [viewMode, setViewMode] = useState('widget'); 

    // Admin
    const [isAdmin, setIsAdmin] = useState(false);
    const [showAdminLogin, setShowAdminLogin] = useState(false);
    const [adminPassword, setAdminPassword] = useState('');
    const [authError, setAuthError] = useState(null);
    const [filterStatus, setFilterStatus] = useState('ALL');

    // App Data
    const [selectedSeats, setSelectedSeats] = useState([]);
    const [isPrivateMode, setIsPrivateMode] = useState(false);
    const [showBookingModal, setShowBookingModal] = useState(false);
    const [showInquiryModal, setShowInquiryModal] = useState(false);
    const [showSuccessModal, setShowSuccessModal] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [submitError, setSubmitError] = useState(null);
    const [editingBookingId, setEditingBookingId] = useState(null);
    const [infoData, setInfoData] = useState(null);
    const [confirmData, setConfirmData] = useState(null);
    
    // Alarm
    const [isMuted, setIsMuted] = useState(true);
    const [hasPending, setHasPending] = useState(false);

    const [config, setConfig] = useState({
        vipPrice: 1200,
        windowPrice: 1000,
        middlePrice: 900,
        privatePrice: 6000,
        discounts: { 2: 5, 3: 10, 4: 12, 5: 15, 6: 20 },
        tripName: 'TEOTIHUACÃN â˜€ï¸',
        tripDate: 'Saturday 8:00 AM',
        tripTimestamp: getNextSaturday(),
        noticeText: 'Meeting: Angel (15m early).\n(Premium Leather)',
        // OPERATING COSTS (New Default 1200 Total)
        fuelCost: 200,
        tollCost: 220,
        parkingCost: 100,
        amenitiesCost: 200,
        laborCost: 0, // User's time is profit
        vehicleCost: 480, // Adjusted to make total exactly 1200
        otherCost: 0,
        targetProfit: 2500
    });

    const [formData, setFormData] = useState({
        name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '', message: ''
    });

    const [timeLeft, setTimeLeft] = useState("");

    // --- EFFECTS ---
    useEffect(() => {
        // Safety Timeout
        const safetyTimer = setTimeout(() => {
            if(loading) {
                console.warn("Forcing load due to timeout");
                setLoading(false);
            }
        }, 4000);

        // Auth
        setLoadingMsg("Signing in...");
        signInAnonymously(auth).then(() => {
            setLoadingMsg("Connecting to Database...");
        }).catch(e => {
            if (e.code === 'auth/operation-not-allowed') setAuthError("Enable Anonymous Auth in Firebase Console.");
            else setAuthError(e.message);
            setLoading(false);
        });

        onAuthStateChanged(auth, u => {
            if (u) { setUser(u); setAuthError(null); }
            else { setUser(null); }
        });

        onValue(ref(db, ".info/connected"), snap => setIsConnected(!!snap.val()));
        onValue(ref(db, "config"), snap => { if (snap.val()) setConfig(prev => ({...prev, ...snap.val()})); });
        
        onValue(ref(db, 'bookings'), snap => {
            const data = snap.val();
            const list = [];
            if (data) Object.keys(data).forEach(k => list.push({ id: k, ...data[k] }));
            list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            setReservations(list);
            setLoading(false);
        }, (err) => {
            console.error("DB Error", err);
            setLoading(false);
        });

        onValue(ref(db, 'inquiries'), snap => {
            const data = snap.val();
            const list = [];
            if (data) Object.keys(data).forEach(k => list.push({ id: k, ...data[k] }));
            list.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            setInquiries(list);
        });

        return () => clearTimeout(safetyTimer);
    }, []);

    // Alarm Logic
    useEffect(() => {
        const pendingExists = reservations.some(r => r.status === 'pending' || r.status === 'pending_review');
        setHasPending(pendingExists);
        if (pendingExists && !isMuted && isAdmin) {
            const interval = setInterval(() => playAlertSound(), 5000);
            return () => clearInterval(interval);
        }
    }, [reservations, isMuted, isAdmin]);

    // Countdown Logic
    useEffect(() => {
        const t = setInterval(() => {
            if (!config.tripTimestamp) return;
            const d = config.tripTimestamp - Date.now();
            if (d < 0) setTimeLeft("Departed");
            else setTimeLeft(`${Math.floor(d/864e5)}d ${Math.floor((d%864e5)/36e5)}h ${Math.floor((d%36e5)/6e4)}m`);
        }, 1000);
        return () => clearInterval(t);
    }, [config.tripTimestamp]);

    // --- COMPUTED ---
    const occupiedSeats = useMemo(() => {
        const map = {};
        reservations.forEach(r => {
            if (r.status === 'cancelled') return;
            if (editingBookingId && r.id === editingBookingId) return;
            
            let s = r.status === 'confirmed' ? 'sold' : 'hold';
            if (r.isManualBlock) s = 'block';
            if (r.status === 'pending_review') s = 'hold'; // Hold seats for review too

            if (Array.isArray(r.seats)) r.seats.forEach(id => map[id] = { status: s, name: r.name, id: r.id });
        });
        return map;
    }, [reservations, editingBookingId]);

    // CHECK IF ANY SEATS ARE TAKEN (For disabling private option)
    const hasActiveBookings = useMemo(() => {
        return Object.keys(occupiedSeats).length > 0;
    }, [occupiedSeats]);

    const quote = useMemo(() => {
        if (isPrivateMode) {
            return { base: config.privatePrice, disc: 0, total: parseInt(config.privatePrice), count: 6, isPriv: true };
        }
        let b = 0;
        selectedSeats.forEach(id => {
            if (['seat2', 'seat3'].includes(id)) b += parseInt(config.vipPrice);
            else if (id === 'seat5') b += parseInt(config.middlePrice);
            else b += parseInt(config.windowPrice);
        });
        const c = selectedSeats.length;
        let d = c >= 6 ? (config.discounts?.[6] || 20) : (config.discounts?.[c] || 0);
        return { base: b, disc: d, total: Math.round(b * (1 - d / 100)), count: c, isPriv: false };
    }, [selectedSeats, config, isPrivateMode]);

    // PROFITABILITY CALC
    const getProfitStats = (revenue) => {
        const baseCost = Number(config.fuelCost) + Number(config.tollCost) + Number(config.parkingCost) + Number(config.amenitiesCost) + Number(config.laborCost) + Number(config.vehicleCost) + Number(config.otherCost);
        const minRev = baseCost; // Break-even point is now just the cost
        const targetRev = baseCost + Number(config.targetProfit);
        const profit = revenue - baseCost;
        const margin = baseCost > 0 ? Math.round((profit / baseCost) * 100) : 0;
        
        let status = 'good'; // Green (> Target)
        if (revenue < baseCost) status = 'loss'; // Red (< 1200)
        else if (revenue < targetRev) status = 'low'; // Yellow (1200 - 3700)

        return { baseCost, minRev, targetRev, profit, margin, status };
    };

    // --- HANDLERS ---
    const handleSeatClick = (id) => {
        if (viewMode === 'dashboard' && isAdmin) {
            const current = occupiedSeats[id];
            if (current) {
                if (confirm(`Release seat ${id}?`)) {
                    const r = reservations.find(x => x.id === current.id);
                    if (r && r.seats) {
                        const ns = r.seats.filter(s => s !== id);
                        if (ns.length === 0) remove(ref(db, `bookings/${current.id}`));
                        else update(ref(db, `bookings/${current.id}`), { seats: ns });
                    }
                }
            } else {
                const nr = push(ref(db, 'bookings'));
                set(nr, { name: "ADMIN BLOCK", seats: [id], status: 'hold', isManualBlock: true, createdAt: Date.now(), createdBy: user ? user.uid : 'admin' });
            }
            return;
        }

        if (occupiedSeats[id]) return;

        setSelectedSeats(prev => {
            const n = prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id];
            
            // AUTO-PRIVATE PROMPT LOGIC RESTORED
            if (n.length === 6 && !isPrivateMode) {
                if (confirm("You selected all 6 seats. Would you like to book this tour as a private experience?")) {
                    setIsPrivateMode(true);
                }
            }
            
            return n;
        });
    };

    const handleSave = async (e) => {
        e.preventDefault();
        setSubmitError(null);
        setIsSubmitting(true);
        try {
            let u = user;
            if (!u) { const c = await signInAnonymously(auth); u = c.user; setUser(u); }
            
            // Safety check: Can't book private if seats occupied
            if (isPrivateMode && hasActiveBookings && !editingBookingId) {
                throw new Error("Cannot book private tour: Seats are already occupied.");
            }

            // Profitability Logic
            const stats = getProfitStats(quote.total);
            let bookingStatus = isAdmin ? 'confirmed' : 'pending';
            let finalPrivate = isPrivateMode;
            let finalTotal = quote.total;

            // Rule 1: Revenue < Break-even (1200)
            if (!isPrivateMode && !isAdmin && quote.total < stats.baseCost) {
                 if (confirm(`This booking is below the minimum (${stats.baseCost} MXN) required to operate this tour.\n\nWould you like to upgrade to a Private Tour ($${config.privatePrice}) to guarantee departure?`)) {
                     finalPrivate = true;
                     finalTotal = parseInt(config.privatePrice);
                     // proceed as pending
                 } else {
                     bookingStatus = 'pending_review'; // Forced review
                     alert("Note: Your booking is below the minimum revenue. It has been submitted for ADMIN REVIEW. We will contact you shortly.");
                 }
            } 
            // Rule 2: Revenue < Target (2500+1200=3700)
            else if (!isPrivateMode && !isAdmin && quote.total < stats.targetRev) {
                 if (confirm(`Upgrade to a Private Tour for a more exclusive experience?\n\nPrivate Price: $${config.privatePrice}`)) {
                     finalPrivate = true;
                     finalTotal = parseInt(config.privatePrice);
                 }
                 // If No, proceed as normal pending (allowed)
            }

            const d = {
                ...formData,
                seats: finalPrivate ? ALL_SEATS : selectedSeats,
                totalPrice: finalTotal,
                originalPrice: quote.base,
                discount: quote.disc,
                isPrivate: finalPrivate,
                tripDate: config.tripDate,
                tripName: config.tripName,
                updatedAt: Date.now()
            };

            if (editingBookingId) {
                await update(ref(db, `bookings/${editingBookingId}`), d);
                alert("Updated!");
                setEditingBookingId(null);
                if (isAdmin) setViewMode('dashboard');
            } else {
                await set(push(ref(db, 'bookings')), { ...d, status: bookingStatus, createdAt: Date.now(), createdBy: u.uid });
                if(bookingStatus !== 'pending_review') setShowSuccessModal(true);
            }
            setShowBookingModal(false);
            setSelectedSeats([]);
            setIsPrivateMode(false);
            setFormData({ name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '' });
        } catch (x) {
            setSubmitError(x.message);
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleInquirySubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
            await set(push(ref(db, 'inquiries')), { ...formData, status: 'NEW', timestamp: Date.now(), source: config.tripName });
            alert("Sent!");
            setShowInquiryModal(false);
            setFormData(p => ({ ...p, message: '' }));
        } catch (x) {
            alert(x.message);
        } finally {
            setIsSubmitting(false);
        }
    };

    // --- HELPERS ---
    const hIn = e => { const { name, value } = e.target; setFormData(p => ({ ...p, [name]: value })); };
    const hDate = e => { if (e.target.value) { const d = new Date(e.target.value); setConfig(p => ({ ...p, tripTimestamp: d.getTime(), tripDate: d.toLocaleString('en-US', { weekday: 'long', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) })); } };
    
    const openWhatsApp = (r) => {
        const t = `Hello ${r.name}, thank you for reserving with GoVibeMX! ðŸš\n\nWe're confirming your request:\nâ€¢ Trip: ${r.tripName}\nâ€¢ Date: ${r.tripDate}\nâ€¢ Pick-up: ${r.location}\nâ€¢ Seats: ${r.isPrivate ? 'PRIVATE' : r.seats?.join(', ')}\nâ€¢ Total: $${r.totalPrice}`;
        window.top.location.href = `https://api.whatsapp.com/send?phone=${r.phone.replace(/\D/g, '')}&text=${encodeURIComponent(t)}`;
    };

    const startEdit = (r) => {
        setEditingBookingId(r.id);
        setSelectedSeats(r.seats || []);
        setIsPrivateMode(r.isPrivate || false);
        setFormData({ name: r.name || '', phone: r.phone || '', email: r.email || '', location: r.location || '', contactMethod: r.contactMethod || 'WhatsApp', hasWhatsApp: r.hasWhatsApp, notes: r.notes || '' });
        setViewMode('widget');
    };

    const handleStartNewBooking = () => {
        setEditingBookingId(null);
        setSelectedSeats([]);
        setIsPrivateMode(false);
        setFormData({ name: '', phone: '', email: '', location: '', contactMethod: 'WhatsApp', hasWhatsApp: true, notes: '' });
        setViewMode('widget'); 
    };

    const deleteBooking = async () => {
        if (!confirmData) return;
        try {
            if (confirmData.type === 'del') await remove(ref(db, `bookings/${confirmData.id}`));
            else if (confirmData.type === 'wipe') await remove(ref(db, 'bookings'));
            setConfirmData(null);
        } catch (e) { alert(e.message); }
    };

    const toggleMute = () => { setIsMuted(!isMuted); };

    // --- RENDER HELPERS ---
    const Seat = ({ id, label, sub, type, ia = true }) => {
        const d = occupiedSeats[id];
        const s = d ? d.status : null;
        let c = `gv-seat seat-${type}`;
        if (s === 'sold') c = 'gv-seat seat-sold';
        else if (s === 'hold') c = 'gv-seat seat-hold';
        else if (s === 'block') c = 'gv-seat seat-block';
        if (selectedSeats.includes(id)) c = 'gv-seat seat-selected';
        if (!ia) c += ' cursor-default';
        if (isAdmin && viewMode === 'dashboard') c += ' cursor-pointer ring-2 ring-white';
        
        let pr = 0;
        if (['seat2', 'seat3'].includes(id)) pr = config.vipPrice;
        else if (id === 'seat5') pr = config.middlePrice;
        else pr = config.windowPrice;

        return (
            <div onClick={ia || (isAdmin && viewMode === 'dashboard') ? () => handleSeatClick(id) : null} className={c}>
                <strong>{label}</strong><span>{sub}</span>
                <div className="seat-tooltip">{isAdmin && d ? d.name : (isPrivateMode ? 'Incl' : `$${pr}`)}</div>
            </div>
        );
    };

    const Map = ({ ia = true }) => (
        <>
            <div className="text-center mb-2 text-[10px] text-slate-500 uppercase">Front</div>
            <div className="flex justify-center gap-4 mb-4"><div className="gv-seat seat-driver"><span className="text-[10px] text-indigo-200 font-bold">DRIVER</span></div><Seat id="seat1" label="#1" sub="Co-Pilot" type="standard" ia={ia} /></div>
            <div className="flex justify-center gap-4 mb-4"><Seat id="seat2" label="#2" sub="Capt" type="vip" ia={ia} /><Seat id="seat3" label="#3" sub="Capt" type="vip" ia={ia} /></div>
            <div className="text-center mb-2 text-[10px] text-slate-500 uppercase">Bench</div>
            <div className="flex justify-center gap-4 mb-6"><Seat id="seat4" label="#4" sub="Win" type="standard" ia={ia} /><Seat id="seat5" label="#5" sub="Mid" type="standard" ia={ia} /><Seat id="seat6" label="#6" sub="Win" type="standard" ia={ia} /></div>
        </>
    );

    if (loading) {
        return (
            <div className="min-h-[600px] bg-slate-900 flex items-center justify-center text-white p-4">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
                    <p className="text-lg">{loadingMsg}</p>
                    {authError && <p className="text-red-400 text-sm mt-4 font-bold">{authError}</p>}
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-[600px] bg-slate-900 font-sans text-slate-100 relative pb-20">
            <div className="fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-slate-800 px-3 py-1 rounded border border-slate-700 shadow text-xs">
                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></div><span>{authError || (isConnected ? 'Online' : '...')}</span>
            </div>

            <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-20">
                <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2"><img src="
